<!DOCTYPE html>
<html lang="de">
<head>
<script>window.__rgv1_disable=true;</script>

<script>
if (!window.__rgErrorBarBound) {
  window.__rgErrorBarBound = true;
  window.__rgShowBanner = function(msg){
    try{
      var bar = document.createElement('div');
      bar.style.position='fixed'; bar.style.left='0'; bar.style.right='0'; bar.style.bottom='0';
      bar.style.background='#3a171b'; bar.style.color='#ffb3ad'; bar.style.padding='8px 12px';
      bar.style.borderTop='1px solid #5a2a28'; bar.style.fontSize='12px'; bar.style.zIndex='99999';
      bar.textContent = msg; document.body.appendChild(bar);
      setTimeout(function(){ try{ bar.remove(); }catch(e){} }, 8000);
    }catch(e){}
  };
  window.addEventListener('error', function(e){
    var m = e && (e.message || (e.error && e.error.message)) || 'Unbekannter Fehler';
    window.__rgShowBanner('JS-Fehler: ' + m);
  });
  window.addEventListener('unhandledrejection', function(e){
    var m = e && (e.reason && (e.reason.message || String(e.reason))) || 'unhandledrejection';
    window.__rgShowBanner('Promise-Fehler: ' + m);
  });
}
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReturnGuard ‚Ä¢ v0.8 (OCR-Profile + Onboarding)</title>
  <meta name="theme-color" content="#0a84ff" />
  <script>
    (function(){
      try{
        var key = 'rg-theme-pref';
        var stored = localStorage.getItem(key);
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = stored || (prefersDark ? 'dark' : 'light');
        var root = document.documentElement;
        if (root) root.setAttribute('data-theme', theme);
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', theme === 'dark' ? '#0b0c0f' : '#f5f7fb');
      }catch(e){}
    })();
  </script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%230a84ff' d='M32 4l22 8v16c0 13.3-8.9 25.3-22 28-13.1-2.7-22-14.7-22-28V12l22-8z'/%3E%3Cpath fill='%23fff' d='M28 38l-7-7 3.5-3.5L28 31l11.5-11.5L43 23 28 38z'/%3E%3C/svg%3E" />
  <!-- External libs (CDN) -->




  <style>
    :root{
      color-scheme: light;
      --bg:#f5f7fb;
      --card:rgba(255,255,255,0.88);
      --card-solid:#ffffff;
      --ink:#101626;
      --muted:#5f6c7b;
      --accent:#0a84ff;
      --danger:#ff453a;
      --warn:#ff9f0a;
      --success:#30d158;
      --line:rgba(15,23,42,0.12);
      --shadow:0 18px 48px rgba(15,23,42,0.12);
      --radius:18px;
      --focus:#74b1ff;
      --surface-alt:rgba(255,255,255,0.78);
      --surface-strong:rgba(255,255,255,0.94);
      --input-bg:rgba(255,255,255,0.9);
      --button-bg:rgba(255,255,255,0.88);
      --hero-text:#0b0c0f;
      --hero-grad-1:#fef9f4;
      --hero-grad-2:#e7f3ff;
      --hero-grad-3:#f4e8ff;
      --hero-outline:rgba(10,132,255,0.16);
      --pill-bg:#eef3ff;
      --dropzone-bg:rgba(255,255,255,0.76);
      --dropzone-drag:rgba(255,255,255,0.95);
      --chip-low:#ffe7ec;
      --chip-mid:#fff4d8;
      --chip-high:#e5f8ec;
      --badge-due-bg:#ffe7ec;
      --badge-due-border:#ffccd5;
      --badge-due-text:#b22a3b;
      --badge-soon-bg:#fff3d6;
      --badge-soon-border:#ffe2a8;
      --badge-soon-text:#9d6500;
      --badge-ok-bg:#e4f7ec;
      --badge-ok-border:#c6ebd3;
      --badge-ok-text:#1f7b3b;
      --warn-bg:#fff4d8;
      --warn-border:#ffd9a1;
      --warn-text:#9d6500;
      --danger-bg:#ffe7ec;
      --danger-border:#ffccd5;
      --danger-text:#b22a3b;
    }
    @media (prefers-color-scheme: dark){
      :root{
        color-scheme: dark;
        --bg:#0b0c0f;
        --card:#13151a;
        --card-solid:#13151a;
        --ink:#eaeef3;
        --muted:#a8b0bc;
        --accent:#0a84ff;
        --danger:#ff453a;
        --warn:#ff9f0a;
        --success:#30d158;
        --line:#20242c;
        --shadow:0 10px 30px rgba(0,0,0,.35);
        --radius:18px;
        --focus:#6ea8ff;
        --surface-alt:#0f1116;
        --surface-strong:#0f1116;
        --input-bg:#0e1015;
        --button-bg:#0f131a;
        --hero-text:#eaeef3;
        --hero-grad-1:#0b0c0f;
        --hero-grad-2:#141824;
        --hero-grad-3:#101726;
        --hero-outline:rgba(255,255,255,0.12);
        --pill-bg:#0f1116;
        --dropzone-bg:#0f1116;
        --dropzone-drag:#0e1116;
        --chip-low:#2a1714;
        --chip-mid:#231a0b;
        --chip-high:#111a13;
        --badge-due-bg:#2a1714;
        --badge-due-border:#5a2a28;
        --badge-due-text:#ffb3ad;
        --badge-soon-bg:#231a0b;
        --badge-soon-border:#4b3a1a;
        --badge-soon-text:#ffd49a;
        --badge-ok-bg:#111a13;
        --badge-ok-border:#26472a;
        --badge-ok-text:#b9f3c9;
        --warn-bg:#24150a;
        --warn-border:#3a2310;
        --warn-text:#ffb14a;
        --danger-bg:#231012;
        --danger-border:#3a171b;
        --danger-text:#ff7a86;
      }
    }
    :root[data-theme="light"]{
      color-scheme: light;
      --bg:#f5f7fb;
      --card:rgba(255,255,255,0.88);
      --card-solid:#ffffff;
      --ink:#101626;
      --muted:#5f6c7b;
      --accent:#0a84ff;
      --danger:#ff453a;
      --warn:#ff9f0a;
      --success:#30d158;
      --line:rgba(15,23,42,0.12);
      --shadow:0 18px 48px rgba(15,23,42,0.12);
      --radius:18px;
      --focus:#74b1ff;
      --surface-alt:rgba(255,255,255,0.78);
      --surface-strong:rgba(255,255,255,0.94);
      --input-bg:rgba(255,255,255,0.9);
      --button-bg:rgba(255,255,255,0.88);
      --hero-text:#0b0c0f;
      --hero-grad-1:#fef9f4;
      --hero-grad-2:#e7f3ff;
      --hero-grad-3:#f4e8ff;
      --hero-outline:rgba(10,132,255,0.16);
      --pill-bg:#eef3ff;
      --dropzone-bg:rgba(255,255,255,0.76);
      --dropzone-drag:rgba(255,255,255,0.95);
      --chip-low:#ffe7ec;
      --chip-mid:#fff4d8;
      --chip-high:#e5f8ec;
      --badge-due-bg:#ffe7ec;
      --badge-due-border:#ffccd5;
      --badge-due-text:#b22a3b;
      --badge-soon-bg:#fff3d6;
      --badge-soon-border:#ffe2a8;
      --badge-soon-text:#9d6500;
      --badge-ok-bg:#e4f7ec;
      --badge-ok-border:#c6ebd3;
      --badge-ok-text:#1f7b3b;
      --warn-bg:#fff4d8;
      --warn-border:#ffd9a1;
      --warn-text:#9d6500;
      --danger-bg:#ffe7ec;
      --danger-border:#ffccd5;
      --danger-text:#b22a3b;
    }
    :root[data-theme="dark"]{
      color-scheme: dark;
      --bg:#0b0c0f;
      --card:#13151a;
      --card-solid:#13151a;
      --ink:#eaeef3;
      --muted:#a8b0bc;
      --accent:#0a84ff;
      --danger:#ff453a;
      --warn:#ff9f0a;
      --success:#30d158;
      --line:#20242c;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --focus:#6ea8ff;
      --surface-alt:#0f1116;
      --surface-strong:#0f1116;
      --input-bg:#0e1015;
      --button-bg:#0f131a;
      --hero-text:#eaeef3;
      --hero-grad-1:#0b0c0f;
      --hero-grad-2:#141824;
      --hero-grad-3:#101726;
      --hero-outline:rgba(255,255,255,0.12);
      --pill-bg:#0f1116;
      --dropzone-bg:#0f1116;
      --dropzone-drag:#0e1116;
      --chip-low:#2a1714;
      --chip-mid:#231a0b;
      --chip-high:#111a13;
      --badge-due-bg:#2a1714;
      --badge-due-border:#5a2a28;
      --badge-due-text:#ffb3ad;
      --badge-soon-bg:#231a0b;
      --badge-soon-border:#4b3a1a;
      --badge-soon-text:#ffd49a;
      --badge-ok-bg:#111a13;
      --badge-ok-border:#26472a;
      --badge-ok-text:#b9f3c9;
      --warn-bg:#24150a;
      --warn-border:#3a2310;
      --warn-text:#ffb14a;
      --danger-bg:#231012;
      --danger-border:#3a171b;
      --danger-text:#ff7a86;
    }
    *{ box-sizing:border-box; }
    html, body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--ink);
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      scroll-behavior:smooth;
    }
    body{
      transition:background 0.6s ease, color 0.6s ease;
    }
    :focus-visible{ outline:2px solid var(--focus); outline-offset:2px; border-radius:8px; }
    header{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:saturate(160%) blur(14px);
      -webkit-backdrop-filter:saturate(160%) blur(14px);
      background:
        linear-gradient(140deg, var(--hero-grad-3) 0%, rgba(255,255,255,0) 65%),
        linear-gradient(180deg, var(--hero-grad-1) 0%, rgba(0,0,0,0) 80%);
      background-color:var(--bg);
      border-bottom:1px solid var(--line);
      transition:background 0.6s ease, border-color 0.6s ease;
    }
    .wrap{ max-width: 1200px; margin:0 auto; padding:18px 16px; }
    .head{ display:flex; align-items:center; gap:12px; }
    .logo{ width:28px; height:28px; display:inline-block; border-radius:8px; overflow:hidden; box-shadow:0 8px 20px rgba(10,132,255,0.22); }
    h1{ margin:0; font-size:22px; letter-spacing:.3px; }
    .subtitle{ color:var(--muted); font-size:13px; margin-top:6px; }
    .hero{
      position:relative;
      margin-top:18px;
      padding:16px;
      border-radius:calc(var(--radius) * 1.15);
      background:linear-gradient(135deg, var(--hero-grad-1) 0%, var(--hero-grad-2) 58%, var(--hero-grad-3) 100%);
      box-shadow:0 28px 60px rgba(10,132,255,0.18);
      overflow:hidden;
      display:grid;
      gap:14px;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      border:1px solid var(--hero-outline);
      pointer-events:none;
    }
    .hero-copy{
      position:relative;
      z-index:2;
      display:grid;
      gap:8px;
      color:var(--hero-text);
    }
    .hero h2{ margin:0; font-size:20px; letter-spacing:.25px; }
    .hero p{ margin:0; font-size:14px; opacity:0.85; }
    .mode-toggle{ display:flex; gap:10px; flex-wrap:wrap; }
    .mode-toggle button{
      background:var(--surface-strong);
      color:var(--hero-text);
      border:1px solid transparent;
      border-radius:999px;
      min-width:120px;
      box-shadow:none;
    }
    .mode-toggle button.is-active{
      background:linear-gradient(140deg, #89d1ff 0%, var(--accent) 100%);
      color:#fff;
      border-color:transparent;
      box-shadow:0 18px 42px rgba(10,132,255,0.35);
    }
    .mode-toggle button span{ display:inline-flex; align-items:center; gap:6px; font-weight:600; }
    .parallax-scene{
      position:relative;
      min-height:160px;
      border-radius:calc(var(--radius) * 0.9);
      overflow:hidden;
    }
    @media (max-width:640px){
      .parallax-scene{ min-height:120px; }
    }
    .parallax-scene .layer{
      position:absolute;
      border-radius:50%;
      opacity:0.85;
      transform:translate3d(0,0,0);
      will-change:transform;
      transition:opacity 0.6s ease;
    }
    .parallax-scene .layer:nth-child(1){
      width:220px; height:220px;
      top:-60px; right:-20px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.85), rgba(110,189,255,0.55) 60%, rgba(10,132,255,0) 100%);
    }
    .parallax-scene .layer:nth-child(2){
      width:180px; height:180px;
      bottom:-60px; right:40px;
      background:radial-gradient(circle at 70% 30%, rgba(255,255,255,0.75), rgba(255,158,194,0.6) 60%, rgba(255,255,255,0));
    }
    .parallax-scene .layer:nth-child(3){
      width:160px; height:160px;
      bottom:10px; left:-40px;
      background:radial-gradient(circle at 30% 70%, rgba(255,255,255,0.7), rgba(137,255,217,0.55) 60%, rgba(255,255,255,0));
    }
    @media (min-width:768px){
      .hero{
        grid-template-columns: minmax(0, 1.1fr) minmax(160px, 0.9fr);
        align-items:center;
      }
      .parallax-scene{ min-height:220px; }
    }
    @media (prefers-reduced-motion: reduce){
      .parallax-scene .layer{ transition:none; transform:none !important; }
    }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; margin-top:18px; }
    @media (max-width:1050px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter:blur(18px);
      -webkit-backdrop-filter:blur(18px);
      transition:background 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
      overflow:hidden;
    }
    .card .hd{ padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .card .bd{ padding:16px; background:var(--card-solid); transition:background 0.5s ease; }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--pill-bg);
      font-size:13px; color:var(--muted);
      transition:background 0.4s ease, border-color 0.4s ease, color 0.4s ease;
    }
    .pill .dot{ width:8px; height:8px; border-radius:50%; background:var(--muted); transition:background 0.4s ease; }
    .pill.due .dot{ background:var(--danger); } .pill.soon .dot{ background:var(--warn); } .pill.ok .dot{ background:var(--success); }
    .form-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .form-row + .form-row{ margin-top:12px; }
    .form-row-3{ display:grid; grid-template-columns: 1.2fr .8fr .8fr; gap:12px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; transition:color 0.4s ease; }
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%; padding:12px 12px; border-radius:12px;
      background:var(--input-bg); color:var(--ink);
      border:1px solid var(--line); outline:none; resize:vertical;
      transition:background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
    }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input:focus, textarea:focus, select:focus{ box-shadow:0 0 0 3px rgba(10,132,255,0.16); }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    button, .btn{
      appearance:none; padding:10px 14px; border-radius:12px;
      border:1px solid var(--line); background:var(--button-bg);
      color:var(--ink); cursor:pointer; font-weight:600;
      transition:background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease, transform 0.2s ease;
    }
    button:hover, .btn:hover{ transform:translateY(-1px); }
    button:active, .btn:active{ transform:translateY(0); }
    button.primary{
      background:linear-gradient(135deg, #89d1ff 0%, var(--accent) 100%);
      border-color:transparent; color:#fff;
      box-shadow:0 16px 34px rgba(10,132,255,0.32);
    }
    button.primary:active{ box-shadow:0 8px 20px rgba(10,132,255,0.3); }
    button.ghost{ background:transparent; }
    button.warn{ background:var(--warn-bg); border-color:var(--warn-border); color:var(--warn-text); }
    button.danger{ background:var(--danger-bg); border-color:var(--danger-border); color:var(--danger-text); }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbar input[type="search"]{ flex:1; min-width:180px; padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:var(--input-bg); color:var(--ink); }
    .toolbar .select{ padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:var(--input-bg); color:var(--ink); }
    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top; transition:color 0.4s ease, border-color 0.4s ease; }
    th{ font-size:12px; color:var(--muted); font-weight:600; }
    td .tag{ font-size:12px; color:var(--muted); }
    tr:last-child td{ border-bottom:none; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); transition:background 0.4s ease, border-color 0.4s ease, color 0.4s ease; }
    .badge.due{ border-color:var(--badge-due-border); background:var(--badge-due-bg); color:var(--badge-due-text); }
    .badge.soon{ border-color:var(--badge-soon-border); background:var(--badge-soon-bg); color:var(--badge-soon-text); }
    .badge.ok{ border-color:var(--badge-ok-border); background:var(--badge-ok-bg); color:var(--badge-ok-text); }
    .empty{ color:var(--muted); text-align:center; padding:30px 10px; border:1px dashed var(--line); border-radius:16px; }
    .muted{ color:var(--muted); }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    .small{ font-size:12px; color:var(--muted); }
    .foot{ color:var(--muted); font-size:12px; text-align:center; padding:18px 8px; }
    .hl{ color:#d3e7ff; }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .hidden{ display:none !important; }
    video{ width:100%; border-radius:12px; border:1px solid var(--line); background:#000; }
    .status{ display:flex; gap:10px; flex-wrap:wrap; }
    .status .pill{ background:var(--surface-alt); }
    .ok{ color:#b9f3c9; } .warn-txt{ color:#ffd49a; } .err{ color:#ffb3ad; }
    .note{ font-size:12px; color:var(--muted); margin-top:6px; }
    dialog.edit-sheet{ border:none; padding:0; width:min(760px,96vw); border-radius:16px; background:var(--card); color:var(--ink); box-shadow:var(--shadow); border:1px solid var(--line); }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .sheet-hd{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); }
    .sheet-bd{ padding:16px; background:var(--card-solid); }
    .sheet-actions{ display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--line); background:var(--card-solid); }
    .capture-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width:900px){ .capture-grid{ grid-template-columns:1fr; } }
    .dropzone{ border:1px dashed var(--line); border-radius:14px; padding:16px; text-align:center; color:var(--muted); background:var(--dropzone-bg); transition:background 0.4s ease, border-color 0.4s ease; }
    .dropzone.drag{ background:var(--dropzone-drag); }
    .preview{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .preview canvas{ max-width:100%; border-radius:12px; border:1px solid var(--line); }
    progress{ width:100%; height:10px; border-radius:999px; }
    .draft-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width:800px){ .draft-grid{ grid-template-columns:1fr; } }
    .conf{ font-size:12px; color:var(--muted); }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 0; }
    .chip{ font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); transition:background 0.4s ease, border-color 0.4s ease, color 0.4s ease; }
    .chip.low{ background:var(--chip-low); border-color:var(--badge-due-border); color:var(--badge-due-text); }
    .chip.mid{ background:var(--chip-mid); border-color:var(--badge-soon-border); color:var(--badge-soon-text); }
    .chip.high{ background:var(--chip-high); border-color:var(--badge-ok-border); color:var(--badge-ok-text); }
    .fab{ position:fixed; right:18px; bottom:18px; z-index:20; display:flex; gap:10px; }
    .fab button{ border-radius:999px; padding:14px 16px; font-size:16px; box-shadow:0 12px 24px rgba(0,0,0,.35); }
    .chooser{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:30; }
    .chooser .box{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; width:min(520px,96vw); box-shadow:var(--shadow); }
    .chooser .opts{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; }
    @media (max-width:680px){ .chooser .opts{ grid-template-columns:1fr; } }
    .chooser .opt{ border:1px solid var(--line); border-radius:12px; padding:12px; text-align:center; cursor:pointer; background:var(--surface-alt); transition:background 0.4s ease, border-color 0.4s ease, transform 0.3s ease; }
    .chooser .opt:hover{ transform:translateY(-2px); outline:2px solid var(--focus); }
    [data-scroll-reveal]{ opacity:0; transform:translate3d(0,32px,0); transition: opacity 0.8s ease, transform 0.8s cubic-bezier(.22,.61,.36,1); }
    [data-scroll-reveal].is-visible{ opacity:1; transform:none; }
    @media (prefers-reduced-motion: reduce){
      [data-scroll-reveal]{ opacity:1 !important; transform:none !important; }
    }
    #js_required_overlay{
      position:fixed; inset:0;
      background:var(--bg);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
      color:var(--ink); z-index:99999; padding:24px; text-align:center;
    }
    #js_required_overlay .box{
      max-width:720px; background:var(--card); border:1px solid var(--line);
      border-radius:16px; box-shadow:var(--shadow); padding:18px;
    }
    #js_required_overlay h2{margin:0 0 8px 0;font-size:18px}
    #js_required_overlay p{margin:0;color:var(--muted)}
    html.js-ok #js_required_overlay{display:none}
  </style>
<script>try{document.documentElement.classList.add('js-ok');}catch{}</script>


<script>
// EARLY failsafe binder: makes the + button and chooser work even if the main script fails.
(function(){
  function whenReady(cb){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', cb); } else { cb(); } }
  function $(id){ return document.getElementById(id); }
  function qs(sel){ return document.querySelector(sel); }
  function showBanner(msg){ try{ (window.__rgShowBanner||console.warn)('[RG]', msg); }catch(e){} }
  whenReady(function(){
    try{
      var btn = $('#btn_plus') || $('#btn_add');
      var chooser = $('#chooser');
      var close = $('#chooser_close') || qs('[data-close="chooser"]');
      if(btn && chooser){ btn.addEventListener('click', function(){ chooser.style.display='flex'; }); btn.addEventListener('touchend', function(e){ e.preventDefault(); chooser.style.display='flex'; }); }
      var fab = document.getElementById('rgv1-fab');
      if(fab && chooser){ fab.addEventListener('click', function(){ chooser.style.display='flex'; }); fab.addEventListener('touchend', function(e){ e.preventDefault(); chooser.style.display='flex'; }); }
      if(close){ close.addEventListener('click', function(){ chooser.style.display='none'; }); }
      // Map quick options
      var opts = chooser ? chooser.querySelectorAll('.opt[data-open]') : null;
      if(opts){ opts.forEach(function(opt){ opt.addEventListener('click', function(){
        var mode = opt.getAttribute('data-open');
        try{
          if(mode==='manual'){ var el = $('#manual_panel')||$('#editPane')||qs('[data-rg-target="manual"]'); if(el) el.scrollIntoView({behavior:'smooth'}); }
          if(mode==='scan'){ var el = $('#scan_panel')||$('#scanner')||qs('[data-rg-target="scan"]'); if(el) el.scrollIntoView({behavior:'smooth'}); }
          if(mode==='ocr'){ var el = $('#ocr_panel')||$('#ocr')||qs('[data-rg-target="ocr"]'); if(el) el.scrollIntoView({behavior:'smooth'}); }
        }catch(e){}
        chooser.style.display='none';
      }); }); }
    }catch(e){ showBanner('Early binder failed: '+e.message); }
  });
})();
</script>


<style id="rg-mobile-v1-styles">
:root{
  --rg-bg: var(--bg);
  --rg-fg: var(--ink);
  --rg-fg-weak: var(--muted);
  --rg-card: var(--card-solid);
  --rg-accent: var(--accent);
  --rg-border: var(--line);
  --rg-radius:16px;
  --rg-shadow: var(--shadow);
}
html,body{ margin:0; padding:0; background:var(--rg-bg); color:var(--rg-fg); -webkit-tap-highlight-color:transparent; }
body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; font-size:16px; line-height:1.35; overflow-x:hidden; }
button,.btn,[role="button"],input[type="button"],input[type="submit"]{ min-height:48px; min-width:48px; font-size:16px; border-radius:14px; padding:12px 16px; border:1px solid var(--rg-border); background:var(--rg-card); color:var(--rg-fg); transition:background 0.4s ease, color 0.4s ease, border-color 0.4s ease; }
input,select,textarea{ font-size:16px; border-radius:12px; border:1px solid var(--rg-border); padding:10px 12px; background:var(--rg-card); color:var(--rg-fg); }
.rgv1-card{ background:var(--rg-card); border:1px solid var(--rg-border); border-radius:var(--rg-radius); box-shadow:var(--rg-shadow); padding:12px; }
.rgv1-grid{ display:grid; gap:12px; grid-template-columns:1fr; }
@media (min-width:768px){ .rgv1-grid.cols-2{grid-template-columns:repeat(2,1fr);} .rgv1-grid.cols-3{grid-template-columns:repeat(3,1fr);} }
.rgv1-topbar{ position:sticky; top:0; z-index:1000; backdrop-filter:saturate(160%) blur(12px); -webkit-backdrop-filter:saturate(160%) blur(12px); background:linear-gradient(180deg, var(--hero-grad-1) 0%, rgba(0,0,0,0) 90%); color:var(--hero-text); padding:12px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--line); }
.rgv1-title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
.rgv1-spacer{ flex:1; }
.rgv1-topbar .rgv1-btn{ background:var(--button-bg); color:var(--ink); border:1px solid var(--line); }
.rgv1-bottombar{ position:fixed; left:0; right:0; bottom:12px; z-index:1000; display:flex; gap:10px; justify-content:center; pointer-events:none; }
.rgv1-bottombar .rgv1-btn{ pointer-events:all; background:var(--rg-card); border:1px solid var(--rg-border); padding:10px 14px; border-radius:14px; box-shadow:var(--rg-shadow); color:var(--rg-fg); }
#rgv1-fab{ position:fixed; right:16px; bottom:16px; z-index:1001; width:64px; height:64px; border-radius:50%; background:var(--rg-accent); color:#fff; font-size:32px; line-height:0; display:flex; align-items:center; justify-content:center; box-shadow:0 12px 28px rgba(10,132,255,.35); border:none; }
#rgv1-fab:active{ transform:translateY(1px) scale(.98); }
.rgv1-hidden{ display:none !important; }
@media (max-width:767px){ .grid,.columns,.row,.rows{ display:grid !important; grid-template-columns:1fr !important; gap:12px !important; } table{ display:block; overflow-x:auto; } }
</style>

<style id="rgv1-mobile-patch">
:root{ --bg:#ffffff; --ink:#14171a; --line:rgba(0,0,0,.12); --bg-soft:rgba(0,0,0,.04); --card-solid:#ffffff; color-scheme:light; }
:root.dark, :root[data-theme="dark"]{ --bg:#0f1115; --ink:#e6e6e6; --line:rgba(255,255,255,.14); --bg-soft:rgba(255,255,255,.08); --card-solid:#151821; color-scheme:dark; }
:where(button,a,input,[role="button"]):focus-visible{ outline:2px solid currentColor; outline-offset:2px; }
@media (max-width:640px){
  header,.hero,.subtitle{display:none !important;} .mode-toggle{display:none !important;}
  .rgv1-topbar,#rgv1-topbar{display:flex;align-items:center;gap:8px;padding:8px 10px;min-height:48px;background:var(--bg);color:var(--ink);border-bottom:1px solid var(--line);backdrop-filter:none;-webkit-backdrop-filter:none;background-image:none !important;box-shadow:none;}
  .rgv1-title{font-size:clamp(14px,3.8vw,16px);font-weight:600;letter-spacing:.1px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .rgv1-spacer{flex:1 1 auto;}
  .rgv1-topbar .rgv1-btn,#rgv1-topbar .rgv1-btn{background:var(--card-solid);border:1px solid var(--line);border-radius:12px;padding:8px 10px;min-height:40px;}
  .rgv1-overflow{padding:8px 12px;border-radius:12px;}
  .rgv1-overflow-menu{position:absolute;right:10px;top:100%;z-index:9999;border:1px solid var(--line);background:var(--card-solid);padding:6px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);}
  .rgv1-overflow-menu[hidden]{display:none !important;}
  .rgv1-overflow-menu button{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;cursor:pointer;border-radius:10px;color:var(--ink);}
  .rgv1-overflow-menu button:hover{background:var(--bg-soft);}
  .rgv1-theme-toggle{padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card-solid);} .rgv1-theme-toggle[aria-pressed="true"]{font-weight:600;}
  #rgv1-bottombar,.rgv1-bottombar{display:none !important;} #rgv1-fab{width:56px;height:56px;right:12px;bottom:12px;}
}
@media (min-width:768px){ .rgv1-topbar,#rgv1-topbar{display:none;} }
</style>
<style id="rg-ocr-integration-style">
@media (max-width:640px){ .rg-ocr-apply{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:var(--card-solid);color:var(--ink);margin-top:8px;} }
@media (min-width:641px){ .rg-ocr-apply{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--card-solid);color:var(--ink);margin-top:6px;} }
.rg-ocr-apply:hover{filter:brightness(.98);}
</style>
<script>
(function(){
  function whenReady(cb){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', cb); } else { cb(); } }
  function $(id){ return document.getElementById(id); }
  function openChooser(ev){
    try{ if (ev && typeof ev.preventDefault === 'function') ev.preventDefault(); }catch(_){}
    var chooser = $('chooser');
    if (chooser){ chooser.style.display = 'flex'; return false; }
    return false;
  }
  window.__rgOpenChooser = openChooser;
  whenReady(function(){
    try{
      var btn=$('btn_plus'), chooser=$('chooser'), close=$('chooser_close');
      if(btn && chooser){ btn.addEventListener('click', openChooser, true); btn.addEventListener('touchend', openChooser, true); }
      var fab = $('rgv1-fab');
      if(fab && chooser){ fab.addEventListener('click', openChooser, true); fab.addEventListener('touchend', openChooser, true); }
      if(close){ close.addEventListener('click', function(){ chooser.style.display='none'; }); }
      document.addEventListener('click', function(e){
        var t = e && e.target && e.target.closest ? e.target.closest('#btn_plus,#rgv1-fab,[data-action=\"plus\"]') : null;
        if (t) openChooser(e);
      }, true);
    }catch(_){}
  });
})();
</script>

<script>
function __rgTriggerDueCheck(){
  try{
    if (navigator.serviceWorker && navigator.serviceWorker.controller){
      navigator.serviceWorker.controller.postMessage({ type: 'CHECK_NOW' });
    }
  }catch{}
}
</script>


<script>
function newId(){
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  alert("Dein Browser ist zu alt (kein crypto.randomUUID). Bitte aktualisieren.");
  throw new Error("UUID required");
}
</script>


<script>
(function(){
  const tests = [
    () => /\\/g,
    () => /\n/g,
    () => /[^a-z0-9_\-\.]+/gi,
    () => /^https?:\/\//
  ];
  try { tests.forEach(make => { if (!(make() instanceof RegExp)) throw new Error('no regex'); }); }
  catch(e){ (window.__rgShowBanner ? __rgShowBanner('Regex-Init fehlgeschlagen: '+e.message) : console.warn('[RG] Regex init failed', e)); }
})();
</script>

</head>
<body>
<div id="rgv1-topbar" class="rgv1-topbar" role="banner" aria-label="ReturnGuard">
  <div class="rgv1-title">ReturnGuard</div>
  <div class="rgv1-spacer"></div>
  <button type="button" class="rgv1-btn" id="rgv1-search" title="Suchen" aria-label="Suchen">üîé</button>
</div>
<div id="rgv1-bottombar" class="rgv1-bottombar" role="toolbar" aria-label="Export-Aktionen">
  <button type="button" class="rgv1-btn" id="rgv1-export-ics7"  title="Kalender (ICS 7 Tage)">ICS 7T</button>
  <button type="button" class="rgv1-btn" id="rgv1-export-ics14" title="Kalender (ICS 14 Tage)">ICS 14T</button>
  <button type="button" class="rgv1-btn" id="rgv1-export-csv"   title="CSV-Export">CSV</button>
  <button type="button" class="rgv1-btn" id="rgv1-export-json"  title="JSON-Export">JSON</button>
</div>
<button type="button" id="rgv1-fab" aria-label="Neu hinzuf√ºgen" title="Neu hinzuf√ºgen" onclick="return (window.__rgOpenChooser ? window.__rgOpenChooser(event) : false);">+</button>


<!-- JS-required notice (shown if inline JS is blocked by viewer/CSP) -->
<div id="js_required_overlay" role="alert">
  <div class="box">
    <h2>JavaScript ist blockiert</h2>
    <p>Die Datei wurde in einem Viewer ge√∂ffnet, der Skripte deaktiviert (z.‚ÄØB. In‚ÄëApp‚ÄëVorschau). Dadurch funktionieren Buttons nicht.</p>
    <p><b>√ñffne die Datei in Chrome oder Firefox</b> (teilen ‚Üí ‚ÄûIm Browser √∂ffnen‚Äú) oder speichere sie und √∂ffne sie aus dem Download‚ÄëOrdner.</p>
    <p class="small" style="margin-top:10px">Hinweis: Service Worker & Benachrichtigungen funktionieren nur √ºber <b>https://</b> oder <b>http://localhost</b>.</p>
  </div>
</div>

<header role="banner">
  <div class="wrap">
    <div class="head" aria-label="App-Kopfzeile">
      <span class="logo" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
          <path fill="#0a84ff" d="M32 4l22 8v16c0 13.3-8.9 25.3-22 28-13.1-2.7-22-14.7-22-28V12l22-8z"/>
          <path fill="#fff" d="M28 38l-7-7 3.5-3.5L28 31l11.5-11.5L43 23 28 38z"/>
        </svg>
      </span>
      <div>
        <h1>ReturnGuard</h1>
        <div class="subtitle">R√ºckgabefristen & Garantien ‚Äì lokal, simpel, ohne Konto.</div>
      </div>
    </div>
    <section class="hero" id="hero_intro" data-scroll-reveal aria-label="Design-Modus">
      <div class="hero-copy">
        <div class="mode-toggle" role="group" aria-label="Modus w√§hlen">
          <button type="button" data-theme-toggle="light"><span>üåû Light</span></button>
          <button type="button" data-theme-toggle="dark"><span>üåô Dark</span></button>
        </div>
      </div>
      <div class="parallax-scene" id="parallax_scene" aria-hidden="true">
        <span class="layer" data-depth="0.08"></span>
        <span class="layer" data-depth="0.16"></span>
        <span class="layer" data-depth="0.28"></span>
      </div>
    </section>
    <div class="kpi" id="kpi" role="status" aria-live="polite" data-scroll-reveal></div>
  </div>
</header>

<!-- Mode chooser (big +) -->
<div class="fab">
  <button type="button" id="btn_plus" class="primary" title="Neuer Eintrag" onclick="return (window.__rgOpenChooser ? window.__rgOpenChooser(event) : false);">Ôºã</button>
</div>
<div class="chooser" id="chooser">
  <div class="box">
    <div><strong>Was willst du erfassen?</strong></div>
    <div class="opts">
      <div class="opt" data-open="cap">üì∏ Foto / OCR</div>
      <div class="opt" data-open="scan">üîé QR / Barcode</div>
      <div class="opt" data-open="manual">‚úçÔ∏è Manuell</div>
    </div>
    <div class="actions" style="justify-content:flex-end; margin-top:10px">
      <button type="button" id="chooser_close" class="btn">Schlie√üen</button>
    </div>
  </div>
</div>

<main class="wrap" role="main">
  <div class="grid">
    <!-- Capture / OCR card -->
    <section class="card" aria-labelledby="capTitle" id="card_cap" style="display:none" data-scroll-reveal>
      <div class="hd">
        <strong id="capTitle">Erfassen (Foto / OCR)</strong>
        <div class="small">Vorschlag durch H√§ndler-Profile (Amazon, MediaMarkt, IKEA, OBI, Google Store)</div>
      </div>
      <div class="bd">
        <div class="capture-grid">
          <div>
            <div class="dropzone" id="drop">
              <div>Ziehe ein Bild hierher oder</div>
              <div class="actions" style="justify-content:center; margin-top:8px">
                <label class="btn"><input id="file_pick" type="file" accept="image/*" class="hidden" />Aus Galerie w√§hlen</label>
                <label class="btn"><input id="file_cam" type="file" accept="image/*" capture="environment" class="hidden" />Kamera</label>
              </div>
              <div class="small" style="margin-top:8px">Tipp: Du kannst Bilder auch <b>einf√ºgen</b> (Strg/‚åò+V).</div>
              <div class="deskew-row">
                <label><input type="checkbox" id="deskew_on" checked /> Auto‚ÄëGerader√ºcken</label>
                <label><input type="checkbox" id="binarize_on" /> Kontrast/Binarisierung</label>
                <span class="small muted">Winkel: <span id="deskew_angle">0¬∞</span></span>
              </div>
            </div>
            <div class="preview" id="preview" style="margin-top:12px"></div>
            <div id="ocr_ui" class="hidden" style="margin-top:12px">
              <div class="small">Erkennung (de+en)‚Ä¶ <span id="ocr_info" class="conf"></span></div>
              <progress id="ocr_progress" value="0" max="1"></progress>
              <textarea id="ocr_text" rows="6" style="margin-top:8px" placeholder="Erkannter Text‚Ä¶"></textarea>
              <div class="actions" style="justify-content:space-between">
                <button type="button" id="btn_parse_profiles" class="btn">Mit H√§ndler‚ÄëProfilen parsen</button>
                <button type="button" id="btn_parse" class="primary">Generisch parsen</button>
              </div>
            </div>
          </div>
          <div>
            <div class="card" style="border:none">
              <div class="hd"><strong>Entwurf</strong><span class="small"> ‚Ä¢ pr√ºfe & √ºbernehme</span></div>
              <div class="bd">
                <div class="draft-grid">
                  <div><label for="d_name">Produkt*</label><input id="d_name" type="text" placeholder="z.B. Kopfh√∂rer Sony WH‚Äë1000XM5" /></div>
                  <div><label for="d_store">H√§ndler / Shop</label><input id="d_store" type="text" /></div>
                  <div><label for="d_date">Kaufdatum</label><input id="d_date" type="date" /></div>
                  <div><label for="d_price">Preis (‚Ç¨)</label><input id="d_price" type="number" min="0" step="0.01" inputmode="decimal" /></div>
                  <div><label for="d_return">R√ºckgabefrist (Tage)</label><input id="d_return" type="number" min="0" step="1" value="14" /></div>
                  <div><label for="d_warranty">Garantie (Monate)</label><input id="d_warranty" type="number" min="0" step="1" value="24" /></div>
                  <div style="grid-column: 1 / -1"><label for="d_notes">Notizen</label><input id="d_notes" type="text" placeholder="z.B. Seriennr., Farbe‚Ä¶" /></div>
                </div>
                <div class="chips" id="hint_chips"></div>
                <div class="actions" style="justify-content:flex-end">
                  <button type="button" id="btn_accept" class="primary">√úbernehmen</button>
                  <button type="button" id="btn_clear_draft" class="ghost">Entwurf leeren</button>
                </div>
                <div class="small muted" style="margin-top:8px">OCR & Parser sind N√§herungen. Werte pr√ºfen. Kein Rechtsrat.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Scan QR/Barcode card -->
    <section class="card" aria-labelledby="scanTitle" id="card_scan" style="display:none" data-scroll-reveal>
      <div class="hd">
        <strong id="scanTitle">Scannen (QR / Barcode)</strong>
        <div class="small">EAN‚Äë13, Code‚Äë128, QR ‚Äì Kamera w√§hlen und starten</div>
      </div>
      <div class="bd">
        <div class="form-row">
          <div>
            <label for="camSel">Kamera</label>
            <select id="camSel"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button type="button" id="scan_start" class="primary">Start</button>
              <button type="button" id="scan_stop" class="ghost">Stopp</button>
            </div>
          </div>
        </div>
        <video id="scan_video" playsinline muted></video>
        <div class="actions" style="justify-content:space-between; align-items:center">
          <div class="small muted" id="scan_info">Bereit.</div>
          <div>
            <button type="button" id="scan_to_draft" class="btn" disabled>Treffer ‚Üí Entwurf</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Manual Add card -->
    <section class="card" aria-labelledby="formTitle" id="card_manual" style="display:none" data-scroll-reveal>
      <div class="hd">
        <strong id="formTitle">Neuer Einkauf (manuell)</strong>
        <div class="small">nur das N√∂tigste eintragen</div>
      </div>
      <div class="bd">
        <div class="form-row">
          <div>
            <label for="f_name">Produkt*</label>
            <input id="f_name" type="text" placeholder="z.B. Kopfh√∂rer Sony WH‚Äë1000XM5" required autocomplete="off" />
          </div>
          <div>
            <label for="f_store">H√§ndler / Shop</label>
            <input id="f_store" type="text" placeholder="z.B. MediaMarkt, Amazon‚Ä¶" autocomplete="off" />
          </div>
        </div>
        <div class="form-row-3" style="margin-top:12px">
          <div><label for="f_date">Kaufdatum</label><input id="f_date" type="date" /></div>
          <div><label for="f_return">R√ºckgabefrist (Tage)</label><input id="f_return" type="number" min="0" step="1" value="14" inputmode="numeric" /></div>
          <div><label for="f_warranty">Garantie (Monate)</label><input id="f_warranty" type="number" min="0" step="1" value="24" inputmode="numeric" /></div>
        </div>
        <div class="form-row" style="margin-top:12px">
          <div><label for="f_price">Preis (optional, ‚Ç¨)</label><input id="f_price" type="number" min="0" step="0.01" placeholder="z.B. 299.00" inputmode="decimal" /></div>
          <div><label for="f_notes">Notizen (optional)</label><input id="f_notes" type="text" placeholder="z.B. Seriennr., Farbe, Bundle‚Ä¶" /></div>
        </div>
        <div class="actions">
          <button type="button" class="primary" id="btn_add" aria-label="Eintrag hinzuf√ºgen">Hinzuf√ºgen</button>
          <button type="button" class="ghost" id="btn_demo">Demo-Daten f√ºllen</button>
          <button type="button" class="ghost" id="btn_clear">Alle archivieren</button>
        </div>
        <p class="small muted" style="margin-top:8px">Hinweis: Widerrufs-/R√ºckgaberechte unterscheiden sich je nach Land & Kaufart. Angaben sind Richtwerte.</p>
      </div>
    </section>

    <!-- List card -->
    <section class="card" aria-labelledby="listTitle" data-scroll-reveal>
      <div class="hd">
        <strong id="listTitle">Liste</strong><span class="small"> ‚Ä¢ offen & archiviert</span>
      </div>
      <div class="bd">
        <div class="toolbar" style="margin-bottom:12px">
          <input id="q" type="search" placeholder="Suchen (Produkt, H√§ndler)‚Ä¶" aria-label="Suchen" />
          <select id="filter" class="select" aria-label="Filter">
            <option value="open">Offen</option>
            <option value="archived">Archiv</option>
            <option value="all">Alle</option>
          </select>
          <select id="sort" class="select" aria-label="Sortieren">
            <option value="urgency">Sortierung: Dringlichkeit</option>
            <option value="date_asc">Kaufdatum ‚Üë</option>
            <option value="date_desc">Kaufdatum ‚Üì</option>
            <option value="name">Name A‚ÜíZ</option>
          </select>
          <button type="button" id="btn_export" class="ghost" aria-label="Export JSON">Export JSON</button>
          <button type="button" id="btn_import" class="ghost" aria-label="Import JSON">Import JSON</button>
          <button type="button" id="btn_csv" class="ghost" aria-label="CSV Export">CSV</button>
          <button type="button" id="btn_ics7" class="ghost" title="ICS mit R√ºckgaben der n√§chsten 7 Tage">ICS 7T</button>
          <button type="button" id="btn_ics14" class="ghost" title="ICS mit R√ºckgaben der n√§chsten 14 Tage">ICS 14T</button>
        </div>

        <div id="list"></div>
        <div id="empty" class="empty hidden">Noch keine Eintr√§ge. F√ºge oben einen Kauf hinzu.</div>
      </div>
    </section>

    <!-- App & Erinnerungen -->
    <section class="card" aria-labelledby="appTitle" data-scroll-reveal>
      <div class="hd">
        <strong id="appTitle">App & Erinnerungen</strong>
        <div class="small">Installierbar, Offline, lokale Benachrichtigungen</div>
      </div>
      <div class="bd">
        <div class="actions">
          <button type="button" id="btn_install" class="btn">Installieren</button>
          <button type="button" id="btn_notify" class="primary">Erinnerungen aktivieren</button>
          <button type="button" id="btn_test_notif" class="ghost">Test-Reminder</button>
        </div>
        <div class="status" style="margin-top:10px">
          <span class="pill"><span class="dot"></span><span id="sw_status">Service Worker: unbekannt</span></span>
          <span class="pill"><span class="dot"></span><span id="notif_status">Benachrichtigungen: unbekannt</span></span>
          <span class="pill"><span class="dot"></span><span id="bg_status">Background Sync: unbekannt</span></span>
        </div>
        <div class="note">
          Wichtig: Service Worker & Benachrichtigungen funktionieren nur √ºber <b>https://</b> oder <b>http://localhost</b>.
        </div>
      </div>
    </section>
  </div>

  <div class="foot">
    <div>v0.8 ‚Ä¢ H√§ndler‚ÄëProfile (Amazon, MediaMarkt, IKEA, OBI, Google Store) ‚Ä¢ Preprocessing (Deskew + Binarize) ‚Ä¢ Big‚ÄëPlus Onboarding ‚Ä¢ IDB‚Äëonly ‚Ä¢ UUIDs ‚Ä¢ dedupte Reminders ‚Ä¢ eingebettete SW‚ÄëIcons ‚Ä¢ DST‚Äësichere Datumslogik</div>
  </div>
</main>

<dialog class="edit-sheet" id="editSheet" aria-labelledby="editTitle">
  <form method="dialog">
    <div class="sheet-hd">
      <strong id="editTitle">Eintrag bearbeiten</strong>
      <button type="button" id="btn_close_sheet" class="btn">Schlie√üen</button>
    </div>
    <div class="sheet-bd">
      <div class="form-row">
        <div><label for="e_name">Produkt*</label><input id="e_name" type="text" required /></div>
        <div><label for="e_store">H√§ndler / Shop</label><input id="e_store" type="text" /></div>
      </div>
      <div class="form-row-3" style="margin-top:12px">
        <div><label for="e_date">Kaufdatum</label><input id="e_date" type="date" /></div>
        <div><label for="e_return">R√ºckgabefrist (Tage)</label><input id="e_return" type="number" min="0" step="1" /></div>
        <div><label for="e_warranty">Garantie (Monate)</label><input id="e_warranty" type="number" min="0" step="1" /></div>
      </div>
      <div class="form-row" style="margin-top:12px">
        <div><label for="e_price">Preis (‚Ç¨)</label><input id="e_price" type="number" min="0" step="0.01" inputmode="decimal" /></div>
        <div><label for="e_notes">Notizen</label><input id="e_notes" type="text" /></div>
      </div>
    </div>
    <div class="sheet-actions">
      <button type="button" class="btn" id="btn_evidence">Beweise‚Ä¶</button>
      <button type="button" class="warn" id="btn_dup">Duplizieren</button>
      <button type="button" class="danger" id="btn_del">L√∂schen</button>
      <button type="submit" class="primary" id="btn_save">Speichern</button>
    </div>
  </form>
</dialog>

<dialog class="edit-sheet" id="evidenceSheet" aria-labelledby="evTitle">
  <div class="sheet-hd">
    <strong id="evTitle">Beweise</strong>
    <div class="actions">
      <label class="btn"><input id="ev_pick" type="file" multiple class="hidden" accept="image/*,application/pdf" />Dateien hinzuf√ºgen</label>
      <button type="button" id="ev_paste" class="btn">Aus Zwischenablage</button>
      <button type="button" id="ev_export" class="primary">ZIP Export</button>
      <button type="button" id="ev_close" class="btn">Schlie√üen</button>
    </div>
  </div>
  <div class="sheet-bd">
    <div id="ev_list" class="files"></div>
    <div id="ev_empty" class="empty">Noch keine Beweise. F√ºge Bilder/PDFs hinzu.</div>
  </div>
</dialog>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const pad = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); };
  const toISODate = (d) => { const x = new Date(d); if (isNaN(+x)) return null; return x.toISOString().slice(0,10); };
  const mkDate = (iso) => new Date(iso + 'T12:00:00'); // midday fence against DST
  const addDays = (iso, days) => { const d = mkDate(iso); d.setDate(d.getDate() + (days || 0)); return d.toISOString().slice(0,10); };
  const addMonths = (iso, months) => { const d = mkDate(iso); d.setMonth(d.getMonth() + (months || 0)); return d.toISOString().slice(0,10); };
  const daysBetween = (aISO, bISO) => { const a = mkDate(aISO); const b = mkDate(bISO); return Math.round((b - a) / 86400000); };
  const fmtDate = (iso) => { if (!iso) return '‚Äî'; const d = mkDate(iso); return pad(d.getDate()) + '.' + pad(d.getMonth()+1) + '.' + d.getFullYear(); };
  const escapeHtml = s => String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m]));
  const SAFE_ID_RX = /^[A-Za-z0-9._:-]{6,128}$/;

  const __rgScriptLoads = Object.create(null);
  function loadScriptOnce(src){
    if (__rgScriptLoads[src]) return __rgScriptLoads[src];
    __rgScriptLoads[src] = new Promise(resolve => {
      try{
        if (document.querySelector('script[src="' + src + '"]')){ resolve(true); return; }
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve(true);
        s.onerror = () => resolve(false);
        document.head.appendChild(s);
      }catch(e){
        resolve(false);
      }
    });
    return __rgScriptLoads[src];
  }
  async function ensureLibrary(name, check, urls){
    if (check()) return;
    for (const src of urls){
      const ok = await loadScriptOnce(src);
      if (ok && check()) return;
    }
    throw new Error(name + ' konnte nicht geladen werden');
  }
  async function ensureOCR(){
    await ensureLibrary('OCR-Bibliothek', () => !!window.Tesseract, [
      './vendor/tesseract.min.js',
      'https://unpkg.com/tesseract.js@5/dist/tesseract.min.js'
    ]);
  }
  async function ensureZXing(){
    await ensureLibrary('Scanner-Bibliothek', () => !!window.ZXing, [
      './vendor/zxing.min.js',
      'https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js'
    ]);
  }
  async function ensureZip(){
    await ensureLibrary('ZIP-Bibliothek', () => !!window.JSZip, [
      './vendor/jszip.min.js',
      'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js'
    ]);
  }
  function normalizeItem(raw){
    const x = (raw && typeof raw === 'object') ? raw : {};
    const idRaw = String(x.id || '').trim();
    const dateRaw = String(x.date || '').trim();
    const createdAtRaw = String(x.createdAt || '').trim();
    const returnDays = parseInt(x.returnDays, 10);
    const warrantyMonths = parseInt(x.warrantyMonths, 10);
    const price = Number(x.price);
    return {
      id: SAFE_ID_RX.test(idRaw) ? idRaw : newId(),
      name: String(x.name || '').trim() || 'Unbenannt',
      store: String(x.store || '').trim(),
      date: /^\d{4}-\d{2}-\d{2}$/.test(dateRaw) ? dateRaw : todayISO(),
      returnDays: Number.isFinite(returnDays) && returnDays >= 0 ? returnDays : 0,
      warrantyMonths: Number.isFinite(warrantyMonths) && warrantyMonths >= 0 ? warrantyMonths : 0,
      price: Number.isFinite(price) && price >= 0 ? price : 0,
      notes: String(x.notes || '').trim(),
      archived: !!x.archived,
      createdAt: (!Number.isNaN(Date.parse(createdAtRaw)) ? createdAtRaw : new Date().toISOString())
    };
  }
  function normalizeState(rawState){
    const base = (rawState && typeof rawState === 'object') ? rawState : {};
    const items = Array.isArray(base.items) ? base.items : [];
    const out = { items: [] };
    const seen = new Set();
    for (const raw of items){
      const item = normalizeItem(raw);
      while (seen.has(item.id)){ item.id = newId(); }
      seen.add(item.id);
      out.items.push(item);
    }
    return out;
  }

  const THEME_STORAGE_KEY = 'rg-theme-pref';
  function applyTheme(mode, opts){
    const root = document.documentElement;
    if (!root) return;
    const theme = mode === 'dark' ? 'dark' : 'light';
    const persist = !opts || opts.persist !== false;
    if (persist){
      try{ localStorage.setItem(THEME_STORAGE_KEY, theme); }catch(e){}
    }
    root.setAttribute('data-theme', theme);
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if (metaTheme){
      metaTheme.setAttribute('content', theme === 'dark' ? '#0b0c0f' : '#f5f7fb');
    }
    document.querySelectorAll('[data-theme-toggle]').forEach(btn => {
      const target = btn.getAttribute('data-theme-toggle');
      const active = target === theme;
      btn.classList.toggle('is-active', active);
      btn.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
  }
  function initTheme(){
    let stored = null;
    try{ stored = localStorage.getItem(THEME_STORAGE_KEY); }catch(e){}
    if (stored){
      applyTheme(stored, { persist:true });
    } else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light', { persist:false });
    }
    const toggles = document.querySelectorAll('[data-theme-toggle]');
    toggles.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-theme-toggle') || 'light';
        applyTheme(target, { persist:true });
      });
    });
    if (window.matchMedia){
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      const handler = (event) => {
        let pref = null;
        try{ pref = localStorage.getItem(THEME_STORAGE_KEY); }catch(e){}
        if (!pref){
          applyTheme(event.matches ? 'dark' : 'light', { persist:false });
        }
      };
      if (mq.addEventListener) mq.addEventListener('change', handler);
      else if (mq.addListener) mq.addListener(handler);
    }
  }
  function initParallax(){
    const scene = document.getElementById('parallax_scene');
    if (!scene) return;
    const layers = Array.from(scene.querySelectorAll('[data-depth]'));
    if (!layers.length) return;
    const motionQuery = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;
    const isReduced = () => motionQuery && motionQuery.matches;
    const update = () => {
      const y = window.scrollY || window.pageYOffset || 0;
      layers.forEach(layer => {
        const depth = parseFloat(layer.getAttribute('data-depth') || '0');
        const offset = isReduced() ? 0 : y * depth;
        layer.style.transform = `translate3d(0, ${offset.toFixed(2)}px, 0)`;
      });
    };
    update();
    if (!isReduced()){
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (isReduced()) return;
        if (!ticking){
          ticking = true;
          window.requestAnimationFrame(() => {
            update();
            ticking = false;
          });
        }
      }, { passive: true });
    }
    if (motionQuery){
      const onChange = () => {
        if (isReduced()){
          layers.forEach(layer => layer.style.transform = 'translate3d(0,0,0)');
        } else {
          update();
        }
      };
      if (motionQuery.addEventListener) motionQuery.addEventListener('change', onChange);
      else if (motionQuery.addListener) motionQuery.addListener(onChange);
    }
  }
  function initScrollReveal(){
    const targets = document.querySelectorAll('[data-scroll-reveal]');
    if (!targets.length) return;
    const motionQuery = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;
    if (typeof IntersectionObserver === 'undefined' || (motionQuery && motionQuery.matches)){
      targets.forEach(el => el.classList.add('is-visible'));
      return;
    }
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting){
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold:0.15, rootMargin:'0px 0px -40px 0px' });
    targets.forEach(el => observer.observe(el));
  }

  // === IndexedDB ONLY ===
  let db;
  const DB_NAME = 'returnguard_data';
  const DB_VER = 5; // v0.8 bump
  function initDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains('files')){
          const s = d.createObjectStore('files', { keyPath:'id' });
          s.createIndex('by_item', 'itemId', { unique:false });
          s.createIndex('by_item_created', ['itemId','createdAt'], { unique:false });
        }
        if (!d.objectStoreNames.contains('kv')){
          d.createObjectStore('kv', { keyPath:'key' });
        }
      };
      req.onsuccess = (e) => { db = e.target.result; resolve(db); };
      req.onerror = (e) => reject(e.target.error);
    });
  }
  function kvGet(key){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('kv','readonly'); const os = tx.objectStore('kv');
      const r = os.get(key); r.onsuccess = () => resolve(r.result ? r.result.value : null); r.onerror = () => reject(r.error);
    });
  }
  function kvPut(key, value){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('kv','readwrite'); const os = tx.objectStore('kv');
      const r = os.put({ key, value, updatedAt: new Date().toISOString() }); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error);
    });
  }

  const store = {
    async read(){ if (!db) await initDB(); let s = await kvGet('state'); if (!s || !Array.isArray(s.items)) s = {items:[]}; return s; },
    async write(data){ await kvPut('state', data); __rgTriggerDueCheck();
if (navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'STATE_MIRROR', state: data}); } }
  };
  let state = {items:[]};

  // Evidence DB helpers
  function dbAddFile(itemId, file){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('files', 'readwrite');
      const os = tx.objectStore('files');
      const rec = { id: newId(), itemId, name: file.name || ('file_'+Date.now()), type: file.type || 'application/octet-stream', size: file.size || 0, data: null, createdAt: new Date().toISOString() };
      (file.arrayBuffer ? file.arrayBuffer() : new Response(file).arrayBuffer()).then(ab => {
        rec.data = ab; const req = os.add(rec); req.onsuccess = () => resolve(rec); req.onerror = () => reject(req.error);
      }).catch(err => reject(err));
    });
  }
  function dbListFiles(itemId){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('files', 'readonly');
      const os = tx.objectStore('files');
      const ix = os.index('by_item_created');
      const range = IDBKeyRange.bound([itemId, ''], [itemId, '\Ôøø']);
      const out = [];
      ix.openCursor(range).onsuccess = (e) => { const cur = e.target.result; if (cur){ out.push(cur.value); cur.continue(); } else resolve(out); };
      tx.onerror = () => reject(tx.error);
    });
  }
  function dbDeleteFile(id){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('files', 'readwrite'); const req = tx.objectStore('files').delete(id);
      tx.oncomplete = () => resolve(); req.onerror = () => reject(req.error);
    });
  }

  // Prefill dates
  document.addEventListener('DOMContentLoaded', async () => {
    initTheme();
    initParallax();
    initScrollReveal();
    $('#f_date').value = todayISO(); $('#d_date').value = todayISO();
    await initDB();
    state = normalizeState(await store.read());
    render();
    try{ await kvPut('state', state); __rgTriggerDueCheck();
}catch{}
  });

  // ===== Onboarding chooser =====
  const chooser = $('#chooser'); const btnPlus = $('#btn_plus'); const chooserClose = $('#chooser_close');
  const show = id => { document.querySelectorAll('section[id^="card_"]').forEach(s => s.style.display='none'); $('#'+id).style.display='block'; window.scrollTo({top:0, behavior:'smooth'}); };
  btnPlus.addEventListener('click', () => { chooser.style.display='flex'; });
  chooserClose.addEventListener('click', () => { chooser.style.display='none'; });
  chooser.addEventListener('click', (e) => { if (e.target === chooser) chooser.style.display='none'; });
  chooser.querySelectorAll('.opt').forEach(opt => opt.addEventListener('click', () => { chooser.style.display='none'; const t = opt.getAttribute('data-open'); if (t==='cap') show('card_cap'); if (t==='scan') show('card_scan'); if (t==='manual') show('card_manual'); }));
  // Default: show manual
  show('card_manual');

  // ===== Capture / OCR & parsing =====
  const drop = $('#drop'), filePick = $('#file_pick'), fileCam = $('#file_cam'), preview = $('#preview');
  const ocrUI = $('#ocr_ui'), ocrText = $('#ocr_text'), ocrInfo = $('#ocr_info'), ocrProgress = $('#ocr_progress');
  const deskewToggle = $('#deskew_on'), binToggle = $('#binarize_on'), deskewAngleEl = $('#deskew_angle');
  ;['dragenter','dragover'].forEach(ev => drop && drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('drag'); }));
  ;['dragleave','drop'].forEach(ev => drop && drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('drag'); }));
  drop && drop.addEventListener('drop', e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) handleFile(f); });
  filePick && filePick.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if (f) handleFile(f); });
  fileCam && fileCam.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if (f) handleFile(f); });
  document.addEventListener('paste', (e) => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;
    for (const it of items){ if (it.type && it.type.indexOf('image') === 0){ const f = it.getAsFile(); if (f) handleFile(f); break; } }
  });

  async function handleFile(file){
    preview.innerHTML = ''; ocrText.value = ''; ocrUI.classList.add('hidden');
    const { dataUrl, w, h } = await readAndScaleImage(file, 2200);
    let canv = document.createElement('canvas'); canv.width = w; canv.height = h;
    let ctx = canv.getContext('2d'); const img = await loadImage(dataUrl); ctx.drawImage(img, 0, 0, w, h);
    let angle = 0;
    if (deskewToggle.checked){ const res = autoDeskew(canv); angle = res.angle; canv = res.canvas; ctx = canv.getContext('2d'); deskewAngleEl.textContent = angle.toFixed(1)+'¬∞'; }
    else { deskewAngleEl.textContent = '0¬∞'; }
    if (binToggle.checked){ applyBinarize(canv, 1.2, 18); } // contrast 1.2, threshold 18
    preview.appendChild(canv);
    ocrUI.classList.remove('hidden'); ocrProgress.value = 0; ocrInfo.textContent = '(wird geladen)';
    try{
      await ensureOCR();
      const ocrCanvas = buildOCRCanvas(canv);
      const { data } = await Tesseract.recognize(ocrCanvas, 'deu+eng', {
        logger: m => { if (m.status) ocrInfo.textContent = m.status; if (m.progress != null) ocrProgress.value = m.progress; },
        tessedit_pageseg_mode: '6',
        preserve_interword_spaces: '1'
      });
      ocrText.value = (data && data.text ? data.text : '').trim(); ocrInfo.textContent = 'fertig';
    }catch(err){ ocrText.value = 'OCR fehlgeschlagen: ' + err.message; ocrInfo.textContent = 'Fehler'; }
  }
  function buildOCRCanvas(src){
    const minWidth = 1800;
    const scale = Math.max(1, Math.min(2.2, minWidth / src.width));
    if (scale <= 1.01) return src;
    const out = document.createElement('canvas');
    out.width = Math.round(src.width * scale);
    out.height = Math.round(src.height * scale);
    const cx = out.getContext('2d');
    cx.imageSmoothingEnabled = true;
    cx.imageSmoothingQuality = 'high';
    cx.fillStyle = '#ffffff';
    cx.fillRect(0, 0, out.width, out.height);
    cx.drawImage(src, 0, 0, out.width, out.height);
    return out;
  }
  function autoDeskew(srcCanvas){
    const maxW = 800, ratio = Math.min(1, maxW / srcCanvas.width);
    const w = Math.round(srcCanvas.width * ratio), h = Math.round(srcCanvas.height * ratio);
    const small = document.createElement('canvas'); small.width = w; small.height = h;
    const sctx = small.getContext('2d'); sctx.drawImage(srcCanvas, 0, 0, w, h);
    const testAngles = []; for (let a=-6; a<=6; a+=0.5) testAngles.push(a);
    let bestAngle = 0, bestScore = -Infinity;
    for (const a of testAngles){ const rc = rotateCanvas(small, a); const score = rowProjectionScore(rc); if (score > bestScore){ bestScore = score; bestAngle = a; } }
    if (Math.abs(bestAngle) < 0.3) return { angle: 0, canvas: srcCanvas };
    return { angle: bestAngle, canvas: rotateCanvas(srcCanvas, bestAngle) };
  }
  function rowProjectionScore(canvas){
    const ctx = canvas.getContext('2d'); const { width:w, height:h } = canvas; const id = ctx.getImageData(0,0,w,h); const d = id.data;
    const rows = new Float32Array(h);
    for (let y=0; y<h; y++){ let sum = 0; for (let x=0; x<w; x++){ const i = (y*w + x) * 4; const lum = (0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]); sum += (255 - lum); } rows[y] = sum; }
    let mean = 0; for (let i=0;i<h;i++) mean += rows[i]; mean /= h;
    let varSum = 0, diffSum = 0; for (let i=0;i<h;i++){ const v = rows[i]-mean; varSum += v*v; if (i>0) diffSum += Math.abs(rows[i]-rows[i-1]); }
    return (varSum / h) + (diffSum / h);
  }
  function rotateCanvas(src, angleDeg){
    const rad = angleDeg * Math.PI/180; const sw = src.width, sh = src.height; const cos = Math.abs(Math.cos(rad)), sin = Math.abs(Math.sin(rad));
    const dw = Math.floor(sw*cos + sh*sin), dh = Math.floor(sw*sin + cos*sh); const dst = document.createElement('canvas'); dst.width = dw; dst.height = dh;
    const ctx = dst.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,dw,dh); ctx.translate(dw/2, dh/2); ctx.rotate(rad); ctx.drawImage(src, -sw/2, -sh/2); return dst;
  }
  function applyBinarize(canvas, contrast=1.2, thresh=18){
    const ctx = canvas.getContext('2d'); const id = ctx.getImageData(0,0,canvas.width,canvas.height); const d = id.data;
    for (let i=0;i<d.length;i+=4){
      // grayscale
      let g = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
      // contrast
      g = ((g-128)*contrast)+128;
      // threshold
      const v = g < (128 - thresh) ? 0 : (g > (128 + thresh) ? 255 : g);
      d[i]=d[i+1]=d[i+2]=v; d[i+3]=255;
    }
    ctx.putImageData(id,0,0);
  }
  function loadImage(src){ return new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = src; }); }
  function readAndScaleImage(file, maxW){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => { const img = new Image(); img.onload = () => {
        let w = img.width, h = img.height; if (w > maxW){ const ratio = maxW / w; w = Math.round(w * ratio); h = Math.round(h * ratio); }
        const c = document.createElement('canvas'); c.width = w; c.height = h; const cx = c.getContext('2d'); cx.fillStyle = '#ffffff'; cx.fillRect(0,0,w,h); cx.drawImage(img, 0, 0, w, h);
        resolve({ dataUrl: c.toDataURL('image/jpeg', 0.92), w, h }); }; img.onerror = reject; img.src = fr.result; };
      fr.onerror = reject; fr.readAsDataURL(file);
    });
  }

  // ===== Parsing (profiles first, then generic) =====
  function parseWithProfiles(text){
    const t = (text || '').replace(/\r/g,'').trim();
    const lines = t.split('\n').map(s => s.trim()).filter(Boolean);
    const raw = t.toLowerCase();
    const profiles = [
      { key:'amazon',      test: /(amazon\.?de|amazon\b)/i, fn: parseAmazon },
      { key:'mediamarkt',  test: /media\s?markt/i,            fn: parseMediaMarkt },
      { key:'ikea',        test: /\bikea\b/i,                fn: parseIkea },
      { key:'obi',         test: /\bobi\b/i,                 fn: parseObi },
      { key:'googlestore', test: /(store\.google|google\s+store)/i, fn: parseGoogleStore },
      { key:'neureiter',   test: /\bneureiter\b|n\s*e\s*u\s*r\s*e\s*i\s*t\s*e\s*r|neureiter-shop|drechselmaschinen/i, fn: parseNeureiter },
    ];
    for (const p of profiles){
      if (p.test.test(t)){ const out = p.fn(lines, t); out.hints = out.hints || []; out.hints.unshift({text:'Profil erkannt: '+p.key, level:'mid'}); return out; }
    }
    return parseGeneric(lines, t);
  }

  function firstMatch(lines, regexList){
    for (const rx of regexList){ for (const s of lines){ const m = s.match(rx); if (m) return { m, s, rx }; } }
    return null;
  }
  function isLikelyInvoiceDate(iso){
    if (!iso) return false;
    const y = +iso.slice(0,4);
    const nowY = new Date().getFullYear();
    return y >= 2015 && y <= (nowY + 1);
  }
  function extractBestInvoiceDate(lines){
    const rx = /([0-3]?\d[.\/\-][01]?\d[.\/\-](?:\d{4}|\d{2}))/g;
    let best = null;
    const nowY = new Date().getFullYear();
    for (let i = 0; i < lines.length; i++){
      const line = lines[i] || '';
      let m;
      while ((m = rx.exec(line))){
        const iso = normalizeDate(m[1]);
        if (!isLikelyInvoiceDate(iso)) continue;
        let score = 1;
        if (/(rechnungs?\s*datum|rechnung\s*nr|datum)/i.test(line)) score += 10;
        if (/(liefer|versand|zahlung|bankeingang)/i.test(line)) score -= 2;
        if (/(tel|fax|uid|iban|bic|kundennummer|auftragsnummer|bestellnummer)/i.test(line)) score -= 8;
        if (i < Math.ceil(lines.length * 0.45)) score += 1;
        const year = +iso.slice(0,4);
        const age = nowY - year;
        if (age >= 0 && age <= 3) score += 2;
        else if (age > 8) score -= 2;
        const cand = { iso, raw:m[1], score, i };
        if (!best || cand.score > best.score || (cand.score === best.score && cand.iso > best.iso)) best = cand;
      }
    }
    return best;
  }
  function extractItemNameFromLine(line){
    let s = sanitizeName(line || '');
    if (!s) return null;
    if (/(zwischensumme|nettosumme|gesamtsumme|mehrwertsteuer|zahlung|versand|rechnung|uid|tel|fax|kundennummer|auftragsnummer|bestellnummer|aktionspreis|artikelbeschreibung|bezeichnung|summe\s*\(eur\))/i.test(s)) return null;
    s = s.replace(/^\s*[0-9A-Z]{1,10}\s+(?:[A-Z]{2,}\d{4,}|[A-Z0-9]{6,})\s+/i, '');
    s = s.replace(/\s+\d{1,3}(?:[.\s]\d{3})*(?:[,\.]\d{2})(?:\s+-?\d{1,3}(?:[.,]\d{2})?%?)?(?:\s+\d{1,3}(?:[.\s]\d{3})*(?:[,\.]\d{2}))?\s*$/i, '');
    s = sanitizeName(s);
    const letters = (s.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]/g)||[]).length;
    if (letters < 6 || s.length < 8 || s.length > 100) return null;
    return s;
  }
  function extractBestInvoiceItem(lines){
    const headerIdx = lines.findIndex(s => /artikelbeschreibung|aktionspreis|bezeichnung/i.test(s));
    const from = headerIdx >= 0 ? headerIdx + 1 : 0;
    const to = Math.min(lines.length, from + 36);
    for (let i = from; i < to; i++){
      const hit = extractItemNameFromLine(lines[i]);
      if (hit) return hit;
    }
    for (let i = 0; i < Math.min(lines.length, 40); i++){
      const s = sanitizeName(lines[i] || '');
      if (!s) continue;
      if (/^MAFELL\b/i.test(s) && !/(summe|gesamt|eur|rechnung)/i.test(s)) return s;
    }
    return '';
  }

  // AMAZON
  function parseAmazon(lines, text){
    const hints = []; let store='Amazon'; let dateISO = null; let price = null; let name = '';
    const dateHit = firstMatch(lines, [/Bestell(?:datum|ung)[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /Rechnungsdatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'high'}); }
    const priceHit = firstMatch(lines, [/Gesamt(?:betrag|summe)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i, /Zahlbetrag[:\s]*([0-9]+[,\.][0-9]{2})/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'high'}); }
    // item name: try lines near "Artikel", otherwise longest plausible
    const idxArtikel = lines.findIndex(s => /Artikel|Bezeichnung/i.test(s));
    if (idxArtikel>=0 && lines[idxArtikel+1]){ name = sanitizeName(lines[idxArtikel+1]); }
    if (!name){ name = bestName(lines, [/amazon/i]); }
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // MEDIAMARKT
  function parseMediaMarkt(lines, text){
    const hints = []; let store='MediaMarkt'; let dateISO = null; let price = null; let name='';
    const dateHit = firstMatch(lines, [/Datum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /Kaufdatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/(?:Gesamtbetrag|SUMME|Total)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'high'}); }
    name = bestName(lines, [/media\s?markt/i, /kassenbon|quittung|summe|ust|mwst/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // IKEA
  function parseIkea(lines, text){
    const hints = []; let store='IKEA'; let dateISO=null; let price=null; let name='';
    const dateHit = firstMatch(lines, [/Datum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})\s+Uhr/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/(?:Gesamt|Summe|TOTAL)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'mid'}); }
    name = bestName(lines, [/ikea/i, /kassenzettel|quittung|summe|mwst|ust/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // OBI
  function parseObi(lines, text){
    const hints = []; let store='OBI'; let dateISO=null; let price=null; let name='';
    const dateHit = firstMatch(lines, [/Datum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/(?:Gesamt|SUMME|Total)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'mid'}); }
    name = bestName(lines, [/obi/i, /kassenbon|quittung|summe|mwst|ust/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // GOOGLE STORE
  function parseGoogleStore(lines, text){
    const hints = []; let store='Google Store'; let dateISO=null; let price=null; let name='';
    const dateHit = firstMatch(lines, [/Bestelldatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /Rechnungsdatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/Gesamt[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i, /Zahlbetrag[:\s]*([0-9]+[,\.][0-9]{2})/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'high'}); }
    name = bestName(lines, [/google/i, /rechnung|bestellung|summe|mwst|ust/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // NEUREITER / klassische Maschinenbau-Rechnungen
  function parseNeureiter(lines, text){
    const hints = [];
    let store = 'Neureiter Maschinen und Werkzeuge';
    let dateISO = null;
    let price = null;
    let name = '';
    const storeLine = lines.find(s => /\bneureiter\b|n\s*e\s*u\s*r\s*e\s*i\s*t\s*e\s*r/i.test(s));
    if (storeLine && !/www\./i.test(storeLine) && !/(tel|fax)/i.test(storeLine) && !/^\s*\(/.test(storeLine)){
      store = sanitizeName(storeLine);
    }
    const bestDate = extractBestInvoiceDate(lines);
    if (bestDate){
      dateISO = bestDate.iso;
      hints.push({ text:'Datum: ' + bestDate.raw, level:'high' });
    }
    const totalHit = firstMatch(lines, [
      /(?:gesamtsumme|endsumme|zu\s*zahlen|zahlbetrag|gesamt\s*eur)\D{0,20}([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i
    ]);
    if (totalHit){
      price = normalizePrice(totalHit.m[1]);
    } else {
      const fallback = extractBestPrice(lines);
      price = fallback.price;
    }
    if (price != null) hints.push({ text:'Preis: ' + price.toFixed(2) + ' ‚Ç¨', level:'high' });
    name = extractBestInvoiceItem(lines);
    if (!name){
      name = bestName(lines, [/\bneureiter\b/i, /rechnung|kopie|summe|uid|tel|fax|artikelnummer|anzahl|eur/i]);
    }
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // GENERIC
  function parseGeneric(lines, text){
    const hints = [];
    // date
    let dateISO = null;
    const labeledDateHit = extractBestInvoiceDate(lines);
    if (labeledDateHit){
      dateISO = labeledDateHit.iso;
    }
    const dateRx = [/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/, /(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})/];
    if (!dateISO){
      for (const line of lines){
        if (/\b(?:tel|fax|uid|iban|bic|kundennummer|auftragsnummer|bestellnummer)\b/i.test(line)) continue;
        for (const rx of dateRx){
          const m = line.match(rx);
          if (m){
            let y, mo, d;
            if (rx === dateRx[0]){ y = +m[1]; mo = +m[2]; d = +m[3]; }
            else { d = +m[1]; mo = +m[2]; y = +m[3]; if (y < 100) y += 2000; }
            if (mo>=1 && mo<=12 && d>=1 && d<=31){
              const iso = y+'-'+pad(mo)+'-'+pad(d);
              if (isLikelyInvoiceDate(iso)){ dateISO = iso; break; }
            }
          }
        }
        if (dateISO) break;
      }
    }
    if (dateISO) hints.push({text:'Datum erkannt: '+fmtDate(dateISO), level:'mid'});
    // price
    const best = extractBestPrice(lines);
    const price = best.price;
    const priceScore = best.score;
    if (price != null) hints.push({text:'Preis erkannt: '+price.toFixed(2)+' ‚Ç¨', level: priceScore>=6?'high':'mid'});
    // store and name
    const avoid = /rechn|receipt|kassenbon|quittung|ust|mwst|steuer|summe|total|betrag|kund|iban|bic|liefer|adresse|stra√üe|str\.|plz|ust-id|ustid|uid|tel|fax|mail|email|steuer-nr|bank|aktionspreis/i;
    const brandHints = /(amazon|mediamarkt|saturn|obi|bauhaus|ikea|spar|billa|hofer|aldi|lidl|intersport|xxx|m√ºller|dm|google|apple|samsung|bosch|hornbach|conrad)/i;
    let store = '';
    if (/\bneureiter\b|n\s*e\s*u\s*r\s*e\s*i\s*t\s*e\s*r|neureiter-shop|drechselmaschinen/i.test(text || '')){
      store = 'Neureiter Maschinen und Werkzeuge';
    }
    for (let i=0;i<Math.min(lines.length,20);i++){
      const s = lines[i]; const letters = (s.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]/g)||[]).length; const digits = (s.match(/[0-9]/g)||[]).length;
      if (!store && letters>=3 && letters>digits && s.length>=2 && s.length<=48 && !avoid.test(s)){ store = s.replace(/\s{2,}/g,' ').trim(); if (brandHints.test(s)) { hints.push({text:'H√§ndler: '+store, level:'high'}); } break; }
    }
    let name = extractBestInvoiceItem(lines);
    if (!name) name = bestName(lines, [brandHints, avoid]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  function baseOut(core, hints){
    const d = { name: core.name || 'Unbenannt', store: core.store || '', date: core.dateISO || todayISO(), price: core.price != null ? core.price : null, returnDays: 14, warrantyMonths: 24, notes: '' };
    return { data: d, hints };
  }
  function bestName(lines, blacklist){
    const bl = blacklist || []; const bad = (s) => bl.some(rx => rx.test && rx.test(s));
    let cand = '';
    for (const s of lines){
      if (bad(s)) continue;
      const letters = (s.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]/g)||[]).length;
      if (letters < 3) continue;
      const ln = s.length;
      if (ln <= 64 && ln >= 6){
        cand = s; break;
      }
    }
    if (!cand){
      const sorted = lines.filter(s => !bad(s)).sort((a,b) => b.length - a.length);
      cand = sorted[0] || 'Unbenannt';
    }
    return sanitizeName(cand);
  }
  function sanitizeName(s){ return s.replace(/\s{2,}/g,' ').replace(/[|‚Ä¢¬∑]{1,}/g,' ').trim(); }
  function normalizeDate(s){
    s = s.replace(/\s/g,'');
    let m = s.match(/^(\d{1,2})[.\/\-](\d{1,2})[.\/\-](\d{2,4})$/);
    if (m){ let d=+m[1], mo=+m[2], y=+m[3]; if (y<100) y+=2000; return y+'-'+pad(mo)+'-'+pad(d); }
    m = s.match(/^(\d{4})[.\/\-](\d{1,2})[.\/\-](\d{1,2})$/);
    if (m){ let y=+m[1], mo=+m[2], d=+m[3]; return y+'-'+pad(mo)+'-'+pad(d); }
    return null;
  }
  function normalizePrice(s){
    const raw = String(s || '').replace(/[^\d,.\-]/g,'').replace(/\s/g,'');
    if (!raw) return null;
    let norm = raw;
    if (raw.indexOf(',') > -1 && raw.indexOf('.') > -1){
      norm = raw.replace(/\./g, '').replace(',', '.');
    } else if (raw.indexOf(',') > -1){
      norm = raw.replace(',', '.');
    } else if (/^\d{1,3}(?:\.\d{3})+$/.test(raw)){
      norm = raw.replace(/\./g, '');
    }
    const val = parseFloat(norm);
    return Number.isFinite(val) ? val : null;
  }
  function extractBestPrice(lines){
    let best = { price:null, score:-999 };
    const pricePattern = /([0-9]{1,3}(?:[.\s][0-9]{3})*(?:[,\.][0-9]{2}))/g;
    for (let i = 0; i < lines.length; i++){
      const line = lines[i] || '';
      let m;
      while ((m = pricePattern.exec(line))){
        const val = normalizePrice(m[1]);
        if (!Number.isFinite(val)) continue;
        let score = 1;
        if (/(gesamtsumme|endsumme|zu\s*zahlen|zahlbetrag|gesamtbetrag|rechnungssumme|total\s*due)/i.test(line)) score += 9;
        else if (/(gesamt|summe|total|betrag)/i.test(line)) score += 5;
        if (/(‚Ç¨|eur|chf|usd)/i.test(line)) score += 2;
        if (/(mwst|ust|steuer|rabatt|skonto|zwischen|netto|pfand|anzahlung|teilzahlung|%-?)/i.test(line)) score -= 6;
        if (/(tel|fax|uid|iban|bic|kundennummer|auftragsnummer|bestellnummer)/i.test(line)) score -= 8;
        if (i > lines.length * 0.5) score += 1;
        if (score > best.score || (score === best.score && val > (best.price || 0))){
          best = { price: val, score };
        }
      }
    }
    return best;
  }

  function parseDraftGeneric(text){ return parseGeneric(text.split('\n'), text); }

  $('#btn_parse').addEventListener('click', () => { const t = ocrText.value || ''; const out = parseGeneric(t.split('\n'), t); fillDraft(out.data); paintHints(out.hints); });
  $('#btn_parse_profiles').addEventListener('click', () => { const t = ocrText.value || ''; const out = parseWithProfiles(t); fillDraft(out.data); paintHints(out.hints); });

  function paintHints(hints){
    const host = $('#hint_chips'); host.innerHTML = ''; (hints||[]).forEach(h => {
      const el = document.createElement('span'); el.className = 'chip ' + (h.level||'mid'); el.textContent = h.text; host.appendChild(el);
    });
  }
  async function fillDraft(d) { $('#d_name').value = d.name || ''; $('#d_store').value = d.store || ''; $('#d_date').value = d.date || todayISO(); $('#d_price').value = d.price != null ? String(d.price) : ''; $('#d_return').value = d.returnDays != null ? String(d.returnDays) : '14'; $('#d_warranty').value = d.warrantyMonths != null ? String(d.warrantyMonths) : '24'; $('#d_notes').value = d.notes || ''; }

  $('#btn_accept').addEventListener('click', async () => {
    const name = $('#d_name').value.trim();
    if (!name){ alert('Produktname ist Pflicht.'); $('#d_name').focus(); return; }
    const item = { id: newId(), name, store: $('#d_store').value.trim(), date: $('#d_date').value || todayISO(), returnDays: Math.max(0, parseInt($('#d_return').value || '0',10)||0), warrantyMonths: Math.max(0, parseInt($('#d_warranty').value || '0',10)||0), price: parseFloat($('#d_price').value || '0') || 0, notes: $('#d_notes').value.trim(), archived:false, createdAt: new Date().toISOString() };
    state.items.push(item); __rgTriggerDueCheck();
await store.write(state); fillDraft({}); render(); alert('Entwurf √ºbernommen.');
  });
  $('#btn_clear_draft').addEventListener('click', () => fillDraft({}));

  // ===== QR/Barcode scanning =====
  const videoEl = $('#scan_video'), camSel = $('#camSel'), scanStart = $('#scan_start'), scanStop = $('#scan_stop'), scanInfo = $('#scan_info'), scanToDraft = $('#scan_to_draft');
  let codeReader = null, currentDeviceId = null, lastResult = null;
  async function initCams(){
    try{
      await ensureZXing();
      codeReader = new ZXing.BrowserMultiFormatReader();
      const devices = await codeReader.listVideoInputDevices();
      camSel.innerHTML = '';
      devices.forEach((d, idx) => { const opt = document.createElement('option'); opt.value = d.deviceId; opt.textContent = d.label || ('Kamera ' + (idx+1)); camSel.appendChild(opt); });
      if (devices[0]) currentDeviceId = devices[0].deviceId;
      scanInfo.textContent = devices.length ? 'Kamera bereit.' : 'Keine Kamera gefunden.';
    }catch(e){ scanInfo.textContent = 'Kamera-Init fehlgeschlagen: ' + e.message; }
  }
  camSel && camSel.addEventListener('change', () => currentDeviceId = camSel.value);
  scanStart && scanStart.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!codeReader){ await initCams(); }
    if (!currentDeviceId){ scanInfo.textContent = 'Keine Kamera verf√ºgbar.'; return; }
    lastResult = null; scanToDraft.disabled = true; scanInfo.textContent = 'Scanning‚Ä¶ (QR, EAN‚Äë13, Code‚Äë128)';
    try{
      await codeReader.decodeFromVideoDevice(currentDeviceId, videoEl, (res, err) => {
        if (res){ lastResult = res; scanInfo.textContent = 'Treffer: [' + res.getBarcodeFormat() + '] ' + res.getText().slice(0,200); scanToDraft.disabled = false; }
      });
    }catch(e){ scanInfo.textContent = 'Fehler: ' + e.message; }
  });
  scanStop && scanStop.addEventListener('click', (e) => { e.preventDefault(); if (codeReader) codeReader.reset(); scanInfo.textContent = 'Gestoppt.'; });
  scanToDraft && scanToDraft.addEventListener('click', () => {
    if (!lastResult) return;
    const fmt = String(lastResult.getBarcodeFormat ? lastResult.getBarcodeFormat() : lastResult.format || 'TEXT');
    const txt = String(lastResult.getText ? lastResult.getText() : lastResult.text || '');
    const d = { name:'', store:'', date: todayISO(), price:null, returnDays:14, warrantyMonths:24, notes:'' };
    if (/^https?:\/\//.test(txt)){ try{ const u = new URL(txt); d.store = u.hostname.replace(/^www\./,''); d.name = 'Bestellung / Link'; d.notes = txt; }catch{ d.notes = txt; } }
    else if (/^\d{13}$/.test(txt) && (fmt==='EAN_13' || /EAN/.test(fmt))){ d.name = 'EAN ' + txt; d.notes = 'Barcode: EAN‚Äë13 ' + txt; }
    else { d.name = txt.slice(0,64); d.notes = 'Scan: ['+fmt+'] ' + (txt.length>120 ? txt.slice(0,120)+'‚Ä¶' : txt); }
    fillDraft(d); scanToDraft.disabled = true; show('card_cap');
  });
  initCams();

  // ===== CRUD & UI =====
  $('#btn_add') && $('#btn_add').addEventListener('click', async () => {
    const name = $('#f_name').value.trim();
    if (!name){ alert('Produktname ist Pflicht.'); $('#f_name').focus(); return; }
    const item = { id: newId(), name, store: $('#f_store').value.trim(), date: $('#f_date').value || todayISO(), returnDays: Math.max(0, parseInt($('#f_return').value || '0',10)||0), warrantyMonths: Math.max(0, parseInt($('#f_warranty').value || '0',10)||0), price: parseFloat($('#f_price').value || '0') || 0, notes: $('#f_notes').value.trim(), archived:false, createdAt: new Date().toISOString() };
    state.items.push(item); __rgTriggerDueCheck();
await store.write(state); clearForm(); render();
  });
$('#btn_clear') && $('#btn_clear').addEventListener('click', async () => { if (!confirm('Alle offenen Eintr√§ge ins Archiv verschieben?')) return; state.items.forEach(it => it.archived = true); await store.write(state); render(); });
  $('#q') && $('#q').addEventListener('input', () => render()); $('#filter') && $('#filter').addEventListener('change', () => render()); $('#sort') && $('#sort').addEventListener('change', () => render());

  $('#btn_export') && $('#btn_export').addEventListener('click', async () => { const data = JSON.stringify(state, null, 2); downloadFile('returnguard_export.json', data, 'application/json'); });
  $('#btn_import') && $('#btn_import').addEventListener('click', async () => {
    const file = await pickFile('.json'); if (!file) return; const text = await file.text();
    try{ const data = JSON.parse(text); if (!data || !Array.isArray(data.items)) throw new Error('Ung√ºltiges Format'); state = normalizeState(data); await store.write(state); render(); alert('Import erfolgreich.'); }
    catch(e){ alert('Import fehlgeschlagen: ' + e.message); }
  });
  $('#btn_csv') && $('#btn_csv').addEventListener('click', async () => {
    const rows = [['ID','Produkt','H√§ndler','Kaufdatum','R√ºckgabefrist(Tage)','R√ºckgabe bis','Garantie(Monate)','Garantie bis','Preis','Archiv','Notizen']];
    state.items.forEach(it => { const {returnDue, warrantyDue} = computeDue(it);
      rows.push([ it.id, it.name, it.store, it.date, it.returnDays, returnDue, it.warrantyMonths, warrantyDue, it.price ? it.price.toFixed(2).replace('.', ',') : '', it.archived ? 'ja' : 'nein', it.notes || '' ]);
    });
    const csv = rows.map(r => r.map(cell => `\"${String(cell).replace(/\"/g,'\"\"')}\"`).join(';')).join('\n');
    downloadFile('returnguard_export.csv', csv, 'text/csv');
  });
  $('#btn_ics7') && $('#btn_ics7').addEventListener('click', () => bulkICS(7)); $('#btn_ics14') && $('#btn_ics14').addEventListener('click', () => bulkICS(14));
  function bulkICS(days){
  const now = todayISO(), until = addDays(now, days);
  const items = state.items.filter(it => {
    if (it.archived) return false;
    const res = computeDue(it);
    const returnDue = res && res.returnDue;
    const daysToReturn = res && res.daysToReturn;
    if (!returnDue) return false;
    const d = returnDue;
    return d >= now && d <= until && daysToReturn >= 0;
  });
  if (!items.length){ alert('Keine R√ºckgaben im gew√§hlten Zeitraum.'); return; }
  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//ReturnGuard//DE',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH'
  ];
  items.forEach(it => {
    const res = computeDue(it);
    const dueISO = res.returnDue;
    const uid = it.id + '-bulk@returnguard.local';
    lines.push(
      'BEGIN:VEVENT',
      'UID:'+uid,
      'DTSTAMP:'+new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z',
      'DTSTART;VALUE=DATE:'+dueISO.replace(/-/g,''),
      'DTEND;VALUE=DATE:'+(addDays(dueISO,1).replace(/-/g,'')),
      'SUMMARY:'+escapeICS('R√ºckgabe: '+(it.name||'‚Äî')),
      'DESCRIPTION:'+escapeICS([
        'Produkt: ' + (it.name||'‚Äî'),
        'H√§ndler: ' + (it.store||'‚Äî'),
        'Kaufdatum: ' + (it.date||'‚Äî'),
        'R√ºckgabefrist: ' + dueISO.split('T')[0],
        'Notizen: ' + (it.notes||'‚Äî')
      ].join('\\n')),
      'END:VEVENT'
    );
  });
  lines.push('END:VCALENDAR');
  const ics = lines.join('\\r\\n');
  downloadFile('ReturnGuard_Rueckgaben_next_'+days+'d.ics', ics, 'text/calendar');
}
function escapeICS(s){
  return String(s)
    .replace(/\\/g, "\\\\")
    .replace(/\r\n/g, "\\n")
    .replace(/\n/g, "\\n")
    .replace(/,/g, "\\,")
    .replace(/;/g, "\\;");
}
function clearForm(){ $('#f_name').value=''; $('#f_store').value=''; $('#f_date').value=todayISO(); $('#f_return').value='14'; $('#f_warranty').value='24'; $('#f_price').value=''; $('#f_notes').value=''; $('#f_name').focus(); }

  function computeDue(it){
    const returnDue = it.returnDays ? addDays(it.date, it.returnDays) : null;
    const warrantyDue = it.warrantyMonths ? addMonths(it.date, it.warrantyMonths) : null;
    const now = todayISO(); const daysToReturn = returnDue ? daysBetween(now, returnDue) : null; const daysToWarranty = warrantyDue ? daysBetween(now, warrantyDue) : null;
    const urgency = (daysToReturn==null) ? 99999 : daysToReturn; return { returnDue, warrantyDue, daysToReturn, daysToWarranty, urgency };
  }
  function urgencyBadge(days){
    if (days == null) return '<span class="badge ok">keine R√ºckgabe</span>';
    if (days < 0) return '<span class="badge due">verpasst</span>';
    if (days === 0) return '<span class="badge due">heute</span>';
    if (days <= 3) return '<span class="badge soon">in '+days+' Tg</span>';
    if (days <= 10) return '<span class="badge">in '+days+' Tg</span>';
    return '<span class="badge ok">in '+days+' Tg</span>';
  }

  function render(){
    const qEl=$('#q'); const filterEl=$('#filter'); const sortEl=$('#sort'); const q=((qEl && qEl.value) || '').trim().toLowerCase(); const filter=(filterEl && filterEl.value) || 'open'; const sort=(sortEl && sortEl.value) || 'urgency';
    const kpiEl = document.getElementById('kpi');
    const k = { dueToday:0, dueSoon:0, ok:0, missed:0 };
    state.items.filter(it => !it.archived).forEach(it => { const {daysToReturn} = computeDue(it);
      if (daysToReturn == null) { k.ok++; return; } if (daysToReturn < 0) k.missed++; else if (daysToReturn === 0) k.dueToday++; else if (daysToReturn <= 3) k.dueSoon++; else k.ok++; });
    if (kpiEl) kpiEl.innerHTML = `<span class="pill due"><span class="dot"></span> Heute f√§llig: <strong>${k.dueToday}</strong></span>
      <span class="pill soon"><span class="dot"></span> In 3 Tagen: <strong>${k.dueSoon}</strong></span>
      <span class="pill ok"><span class="dot"></span> OK: <strong>${k.ok}</strong></span>
      <span class="pill"><span class="dot"></span> Verpasst: <strong>${k.missed}</strong></span>`;

    let items = state.items.filter(it => { if (filter==='open' && it.archived) return false; if (filter==='archived' && !it.archived) return false; if (!q) return true; const t = (it.name + ' ' + (it.store||'') + ' ' + (it.notes||'')).toLowerCase(); return t.includes(q); });

    items.sort((a,b) => { const A = computeDue(a), B = computeDue(b);
      if (sort==='urgency') return A.urgency - B.urgency; if (sort==='date_asc') return a.date.localeCompare(b.date);
      if (sort==='date_desc') return b.date.localeCompare(a.date); if (sort==='name') return a.name.localeCompare(b.name); return 0;
    });

    const listEl = document.getElementById('list'); const emptyEl = document.getElementById('empty');
    if (items.length === 0){ listEl.innerHTML = ''; emptyEl.classList.remove('hidden'); return; }
    emptyEl.classList.add('hidden');
    let html = `<table role="table"><thead><tr>
      <th scope="col">Produkt</th><th scope="col" class="nowrap">Kaufdatum</th><th scope="col" class="nowrap">R√ºckgabe bis</th><th scope="col" class="nowrap">Garantie bis</th><th scope="col" class="right nowrap">Preis</th><th scope="col" class="nowrap">Aktionen</th>
    </tr></thead><tbody>`;
    items.forEach(it => {
      const {returnDue, warrantyDue, daysToReturn} = computeDue(it);
      const dataId = escapeHtml(String(it.id || ''));
      const archBtn = it.archived ? '<button type="button" class="btn" data-act="unarchive" data-id="'+dataId+'">Wiederherstellen<\/button>' : '<button type="button" class="btn" data-act="archive" data-id="'+dataId+'">Archivieren<\/button>';
      html += `<tr>
        <td><div><strong>${escapeHtml(it.name)}</strong></div><div class="tag">${escapeHtml(it.store || '‚Äî')}</div></td>
        <td class="nowrap">${fmtDate(it.date)}</td>
        <td class="nowrap">${returnDue ? fmtDate(returnDue) : '‚Äî'}<div class="small">${urgencyBadge(daysToReturn)}</div></td>
        <td class="nowrap">${warrantyDue ? fmtDate(warrantyDue) : '‚Äî'}</td>
        <td class="right nowrap">${it.price ? (it.price.toFixed(2) + ' ‚Ç¨') : '‚Äî'}</td>
        <td class="nowrap">
          <div class="row-actions">
            <button type="button" class="btn" data-act="calendar" data-id="${dataId}">Kalender</button>
            <button type="button" class="btn" data-act="edit" data-id="${dataId}">Bearbeiten</button>
            ${archBtn}
            <button type="button" class="btn" data-act="evidence" data-id="${dataId}">Beweise</button>
            <button type="button" class="btn warn" data-act="duplicate" data-id="${dataId}">Duplizieren</button>
            <button type="button" class="btn danger" data-act="delete" data-id="${dataId}">L√∂schen</button>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table>'; listEl.innerHTML = html;

    listEl.querySelectorAll('button[data-act]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const act = e.currentTarget.getAttribute('data-act');
        const it = state.items.find(x => x.id === id);
        if (!it) return;
        if (act === 'delete'){ if (!confirm('Eintrag wirklich l√∂schen?')) return; state.items = state.items.filter(x => x.id !== id); await store.write(state); render(); return; }
        if (act === 'archive'){ it.archived = true; await store.write(state); render(); return; }
        if (act === 'unarchive'){ it.archived = false; await store.write(state); render(); return; }
        if (act === 'edit'){ openEditor(it); return; }
        if (act === 'calendar'){ openCalendar(it); return; }
        if (act === 'duplicate'){ const copy = JSON.parse(JSON.stringify(it)); copy.id = newId(); copy.createdAt = new Date().toISOString(); copy.archived = false; state.items.push(copy); __rgTriggerDueCheck();
await store.write(state); render(); return; }
        if (act === 'evidence'){ openEvidence(it); return; }
      });
    });
  }

  // Edit sheet logic
  const sheet = document.getElementById('editSheet'); let currentEditId = null;
  function openEditor(it){
    currentEditId = it.id; document.getElementById('e_name').value = it.name; document.getElementById('e_store').value = it.store || ''; document.getElementById('e_date').value = it.date || todayISO();
    document.getElementById('e_return').value = it.returnDays || 0; document.getElementById('e_warranty').value = it.warrantyMonths || 0; document.getElementById('e_price').value = it.price || 0; document.getElementById('e_notes').value = it.notes || '';
    if (!sheet.open) sheet.showModal(); document.getElementById('e_name').focus();
  }
  document.getElementById('btn_close_sheet').addEventListener('click', () => sheet.close());
  document.getElementById('btn_save').addEventListener('click', async (ev) => {
    ev.preventDefault(); if (!currentEditId) { sheet.close(); return; }
    const it = state.items.find(x => x.id === currentEditId); if (!it){ sheet.close(); return; }
    it.name = document.getElementById('e_name').value.trim() || it.name; it.store = document.getElementById('e_store').value.trim(); it.date = toISODate(document.getElementById('e_date').value) || it.date;
    it.returnDays = Math.max(0, parseInt(document.getElementById('e_return').value||'0',10) || 0); it.warrantyMonths = Math.max(0, parseInt(document.getElementById('e_warranty').value||'0',10) || 0);
    it.price = Math.max(0, parseFloat(document.getElementById('e_price').value||'0') || 0); it.notes = document.getElementById('e_notes').value.trim(); await store.write(state); sheet.close(); render();
  });
  document.getElementById('btn_del').addEventListener('click', async () => { if (!currentEditId) return; if (!confirm('Eintrag wirklich l√∂schen?')) return; state.items = state.items.filter(x => x.id !== currentEditId); await store.write(state); sheet.close(); render(); });
  document.getElementById('btn_dup').addEventListener('click', async () => { if (!currentEditId) return; const src = state.items.find(x => x.id === currentEditId); if (!src) return; const copy = JSON.parse(JSON.stringify(src)); copy.id = newId(); copy.archived = false; copy.createdAt = new Date().toISOString(); state.items.push(copy); __rgTriggerDueCheck();
await store.write(state); render(); alert('Duplikat angelegt.'); });
  document.getElementById('btn_evidence').addEventListener('click', () => { const it = state.items.find(x => x.id === currentEditId); if (it) openEvidence(it); });

  function openCalendar(it){
    const {returnDue} = computeDue(it); if (!returnDue){ alert('F√ºr dieses Produkt ist keine R√ºckgabefrist gesetzt.'); return; }
    const start = returnDue.replace(/-/g,''), endDate = addDays(returnDue, 1).replace(/-/g,'');
    const title = encodeURIComponent('Letzter Tag R√ºckgabe ‚Äì ' + it.name);
    const details = encodeURIComponent(['H√§ndler: ' + (it.store||'‚Äî'), 'Gekauft am: ' + fmtDate(it.date), 'Notizen: ' + (it.notes||'‚Äî')].join('\n'));
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${endDate}&details=${details}`;
    const ics = buildICS(it, returnDue);
    const choice = confirm('Google Kalender √∂ffnen?\n\nOK = Google Kalender\nAbbrechen = .ics herunterladen');
    if (choice){ window.open(url, '_blank', 'noopener'); } else { downloadFile(('ReturnGuard_'+it.name+'_Rueckgabe.ics').replace(/[^a-z0-9_\-\.]+/gi,'_'), ics, 'text/calendar'); }
  }
  function buildICS(it, dueISO){
    const dt = dueISO.replace(/-/g,'');
    const dtEnd = addDays(dueISO, 1).replace(/-/g,'');
    const now = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z'; const uidStr = it.id + '@returnguard.local';
    const lines = [ 'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ReturnGuard//DE','BEGIN:VEVENT','UID:'+uidStr,'DTSTAMP:'+now,'SUMMARY:' + escapeICS('Letzter Tag R√ºckgabe ‚Äì ' + it.name),'DTSTART;VALUE=DATE:'+dt,'DTEND;VALUE=DATE:'+dtEnd,'DESCRIPTION:' + escapeICS(['H√§ndler: ' + (it.store||'‚Äî'), 'Gekauft am: ' + fmtDate(it.date), 'Notizen: ' + (it.notes||'‚Äî')].join('\n')),'END:VEVENT','END:VCALENDAR' ];
    return lines.join('\r\n');
  }

  // Evidence UI
  const evidenceSheet = document.getElementById('evidenceSheet'); const evList = document.getElementById('ev_list'); const evEmpty = document.getElementById('ev_empty'); const evPick = document.getElementById('ev_pick'); const evPaste = document.getElementById('ev_paste'); const evExport = document.getElementById('ev_export'); const evClose = document.getElementById('ev_close');
  let evCurrentItemId = null;
  async function openEvidence(it){
    evCurrentItemId = it.id; document.getElementById('evTitle').textContent = 'Beweise ‚Äì ' + it.name;
    await renderEvidence();
    if (!evidenceSheet.open) evidenceSheet.showModal();
  }
  evClose.addEventListener('click', () => evidenceSheet.close());
  evPick.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    let failed = 0;
    for (const f of files){
      try{ await dbAddFile(evCurrentItemId, f); }
      catch(err){ failed++; console.error('[ReturnGuard] Datei konnte nicht gespeichert werden', err); }
    }
    await renderEvidence();
    e.target.value = '';
    if (failed){ alert(failed + ' Datei(en) konnten nicht gespeichert werden (Speicherplatz/Browser-Limit).'); }
  });
  evPaste.addEventListener('click', async () => {
    if (!navigator.clipboard || !navigator.clipboard.read){ alert('Zwischenablage-Zugriff nicht verf√ºgbar.'); return; }
    try{
      const items = await navigator.clipboard.read();
      let failed = 0;
      for (const it of items){
        for (const type of it.types){
          if (type.startsWith('image/') || type==='application/pdf'){
            const blob = await it.getType(type);
            const f = new File([blob], 'Clipboard_' + Date.now() + (type==='application/pdf'?'.pdf':'.png'), { type });
            try{ await dbAddFile(evCurrentItemId, f); }
            catch(err){ failed++; console.error('[ReturnGuard] Clipboard-Datei konnte nicht gespeichert werden', err); }
          }
        }
      }
      await renderEvidence();
      if (failed){ alert(failed + ' Datei(en) aus der Zwischenablage konnten nicht gespeichert werden.'); }
    }catch(e){ alert('Zwischenablage: ' + e.message); }
  });
  evExport.addEventListener('click', async () => {
    if (!evCurrentItemId) return;
    const item = state.items.find(x => x.id === evCurrentItemId);
    const files = await dbListFiles(evCurrentItemId);
    if (!files.length){ alert('Keine Beweise zum Export.'); return; }
    await ensureZip();
    const zip = new JSZip();
    const manifest = { exportAt: new Date().toISOString(), item: { ...item, dueReturn: computeDue(item).returnDue, dueWarranty: computeDue(item).warrantyDue } };
    zip.file('manifest.json', JSON.stringify(manifest, null, 2));
    files.forEach((f, idx) => { const base = (item.date||'').replace(/-/g,'') + '_' + item.id + '_' + String(idx+1).padStart(2,'0') + '_' + (f.name||('file_'+idx)); zip.file(base, f.data, {binary:true}); });
    const blob = await zip.generateAsync({ type:'blob' }); downloadFile('ReturnGuard_Evidence_' + (item.name||'item').replace(/[^a-z0-9_\-\.]+/gi,'_') + '_' + (item.date||'').replace(/-/g,'') + '.zip', blob, 'application/zip');
  });
  async function renderEvidence(){
    if (!evCurrentItemId){ evList.innerHTML=''; evEmpty.classList.remove('hidden'); return; }
    const files = await dbListFiles(evCurrentItemId);
    evList.innerHTML = '';
    if (!files.length){ evEmpty.classList.remove('hidden'); return; }
    evEmpty.classList.add('hidden');
    for (const f of files){
      const card = document.createElement('div'); card.className = 'file-card';
      const th = document.createElement('div'); th.className = 'thumb';
      if (f.type && f.type.startsWith('image/')){ const img = document.createElement('img'); const blob = new Blob([f.data], { type: f.type || 'application/octet-stream' }); img.src = URL.createObjectURL(blob); th.appendChild(img); img.onload = () => URL.revokeObjectURL(img.src); }
      else { th.textContent = f.type ? f.type.split('/').pop().toUpperCase() : 'FILE'; }
      const info = document.createElement('div'); info.style.flex='1';
      const meta = document.createElement('div'); meta.className='small muted';
      meta.textContent = (f.type||'datei') + ' ‚Ä¢ ' + Math.round((f.size||0)/1024) + ' KB ‚Ä¢ ' + new Date(f.createdAt).toLocaleString();
      info.innerHTML = `<div><strong>${escapeHtml(f.name||'Datei')}</strong></div>`; info.appendChild(meta);
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='L√∂schen';
      del.addEventListener('click', async ()=>{ if (!confirm('Datei l√∂schen?')) return; await dbDeleteFile(f.id); await renderEvidence(); });
      card.appendChild(th); card.appendChild(info); card.appendChild(del); evList.appendChild(card);
    }
  }

  // ===== PWA: Manifest & Service Worker =====
  const manifestLink = document.createElement('link'); manifestLink.rel = 'manifest'; document.head.appendChild(manifestLink);
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('btn_install').disabled = false; });
  document.getElementById('btn_install').addEventListener('click', async () => {
    if (!deferredPrompt){ alert('Install-Prompt noch nicht verf√ºgbar. Versuche √ºber Browser-Men√º ‚ÄûZum Startbildschirm hinzuf√ºgen‚Äú.'); return; }
    deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; if (choice && choice.outcome === 'accepted'){ document.getElementById('btn_install').textContent = 'Installiert (oder in Arbeit)'; } deferredPrompt = null;
  });

  function makeIcon(size){
    const c = document.createElement('canvas'); c.width=size; c.height=size; const ctx=c.getContext('2d');
    const styles = getComputedStyle(document.documentElement);
    const accent = (styles.getPropertyValue('--accent') || '#0a84ff').trim() || '#0a84ff';
    const accentSoft = (styles.getPropertyValue('--hero-grad-2') || '#89d1ff').trim() || accent;
    const g = ctx.createLinearGradient(0,0,size,size);
    g.addColorStop(0, accentSoft);
    g.addColorStop(1, accent);
    ctx.fillStyle=g; ctx.fillRect(0,0,size,size);
    ctx.lineWidth=size*0.12; ctx.strokeStyle='#fff'; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(size*0.22,size*0.55); ctx.lineTo(size*0.38,size*0.71); ctx.lineTo(size*0.78,size*0.29); ctx.stroke();
    return c.toDataURL('image/png');
  }
  (function buildManifest(){
    const icons = [192,512].map(sz => ({ src: makeIcon(sz), sizes: sz+'x'+sz, type:'image/png', purpose:'maskable any' }));
    const styles = getComputedStyle(document.documentElement);
    const bgColor = (styles.getPropertyValue('--bg') || '#0b0c0f').trim() || '#0b0c0f';
    const accent = (styles.getPropertyValue('--accent') || '#0a84ff').trim() || '#0a84ff';
    const manifest = { name: 'ReturnGuard', short_name: 'ReturnGuard', description: 'R√ºckgabefristen & Garantien im Griff ‚Äì offline, privat, ohne Konto.', start_url: './', display: 'standalone', background_color: bgColor, theme_color: accent, icons };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob); manifestLink.href = url;
  })();

  const secureContextOk = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
  const swStatus = document.getElementById('sw_status'), notifStatus = document.getElementById('notif_status'), bgStatus = document.getElementById('bg_status');
  document.getElementById('btn_install').disabled = true;
  const SW_FILE = './sw.returnguard.fix9.js';

  async function registerSW(){
    if (!('serviceWorker' in navigator)){ swStatus.textContent = 'Service Worker: nicht unterst√ºtzt'; return; }
    if (!secureContextOk){ swStatus.innerHTML = 'Service Worker: <span class="warn-txt">kein HTTPS/localhost</span>'; return; }
    try{
      const reg = await navigator.serviceWorker.register(SW_FILE, { scope: './' });
      swStatus.textContent = 'Service Worker: registriert';
      const sendIcon = () => {
        try{
          const payload = { type: 'SET_ICON', iconDataUrl: makeIcon(192) };
          if (navigator.serviceWorker.controller){
            navigator.serviceWorker.controller.postMessage(payload);
          } else if (reg.active){
            reg.active.postMessage(payload);
          }
        }catch(e){}
      };
      navigator.serviceWorker.ready.then(async (r) => {
        if ('periodicSync' in r){
          try{ await r.periodicSync.register('returnguard-due-check', { minInterval: 6*60*60*1000 }); bgStatus.textContent = 'Background Sync: periodic'; }
          catch(e){ bgStatus.textContent = 'Background Sync: eingeschr√§nkt'; }
        } else if ('sync' in r){
          bgStatus.textContent = 'Background Sync: one-off';
          try{ await r.sync.register('returnguard-sync'); } catch {}
        } else { bgStatus.textContent = 'Background Sync: nicht verf√ºgbar'; }
        sendIcon();
        try{ await kvPut('state', state); __rgTriggerDueCheck();
}catch{}
        if (navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); }
      });
      navigator.serviceWorker.addEventListener('controllerchange', sendIcon, { once:true });
    }catch(e){
      swStatus.innerHTML = 'Service Worker: <span class="err">'+e.message+'</span>';
    }
  }

  const btnNotify = document.getElementById('btn_notify'); const btnTestNotif = document.getElementById('btn_test_notif');
  btnNotify.addEventListener('click', async () => {
    if (!secureContextOk){ alert('Aktiviere HTTPS oder starte √ºber http://localhost, sonst keine Benachrichtigungen.'); return; }
    if (!('Notification' in window)){ notifStatus.textContent = 'Benachrichtigungen: nicht unterst√ºtzt'; return; }
    const perm = await Notification.requestPermission();
    if (perm !== 'granted'){ notifStatus.innerHTML = 'Benachrichtigungen: <span class="warn-txt">'+perm+'</span>'; return; }
    notifStatus.textContent = 'Benachrichtigungen: erlaubt';
    await registerSW();
    if (navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); }
  });
  btnTestNotif.addEventListener('click', async () => {
    if (!('Notification' in window)) { alert('Notifications nicht unterst√ºtzt'); return; }
    if (Notification.permission !== 'granted'){
      const perm = await Notification.requestPermission();
      if (perm !== 'granted') return;
    }
    await registerSW();
    const now = todayISO();
    let notified = (await kvGet('notified')) || {};
    let updated = false;
    state.items.forEach(it => {
      if (it.archived || !it.returnDays) return;
      const due = addDays(it.date, it.returnDays);
      const days = daysBetween(now, due);
      if (days < 0 || days > 3) return;
      const key = it.id + ':' + due;
      if (notified[key]) return;
      try{ (function(){ try{ if (navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); } }catch{} })() }catch{}
      notified[key] = true; updated = true;
    });
    if (updated) await kvPut('notified', notified);
    __rgTriggerDueCheck();
if (navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); }
  });

  navigator.serviceWorker && navigator.serviceWorker.addEventListener('message', (e) => {
    if (e.data && e.data.type === 'FOCUS_ITEM'){
      const id = e.data.itemId;
      if (!id) return;
      const btn = document.querySelector('button[data-id="'+id+'"]');
      if (btn){ btn.scrollIntoView({behavior:'smooth', block:'center'}); btn.classList.add('warn'); setTimeout(() => btn.classList.remove('warn'), 1500); }
    }
  });

  // Light periodic check (uses same IDB 'notified' map)
  setInterval(async () => {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;
    const now = todayISO();
    let notified = (await kvGet('notified')) || {};
    let updated = false;
    const s = await store.read();
    s.items.forEach(it => {
      if (it.archived || !it.returnDays) return;
      const due = addDays(it.date, it.returnDays);
      const days = daysBetween(now, due);
      if (days < 0 || days > 3) return;
      const key = it.id + ':' + due;
      if (notified[key]) return;
      try{ (function(){ try{ if (navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); } }catch{} })() }catch{}
      notified[key] = true; updated = true;
    });
    if (updated) await kvPut('notified', notified);
  __rgTriggerDueCheck();
}, 15*60*1000);

  (function initStatus(){
    document.getElementById('btn_install').disabled = true;
    if ('serviceWorker' in navigator){
      if (!secureContextOk){ swStatus.innerHTML = 'Service Worker: <span class="warn-txt">kein HTTPS/localhost</span>'; }
      else { swStatus.textContent = 'Service Worker: bereit'; registerSW(); }
    } else { swStatus.textContent = 'Service Worker: nicht unterst√ºtzt'; }
    if ('Notification' in window){ notifStatus.textContent = 'Benachrichtigungen: ' + Notification.permission; } else { notifStatus.textContent = 'Benachrichtigungen: nicht unterst√ºtzt'; }
    bgStatus.textContent = 'Background Sync: unbekannt';
  })();

  function downloadFile(name, content, mime){ const blob = content instanceof Blob ? content : new Blob([content], {type: mime || 'application/octet-stream'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(url), 1000); }
  async function pickFile(accept){ return new Promise(resolve => { const inp = document.createElement('input'); inp.type='file'; if (accept) inp.accept = accept; inp.onchange = () => resolve(inp.files && inp.files[0] ? inp.files[0] : null); inp.click(); }); }
  
})();
</script>

<script>
// --- v1.0.5 Learn Mode for FAB mapping ---
(function(){
  if (window.__rgv1_disable) return;
  const LS_KEY = 'rgv1.map.add.selector';
  const LS_FN  = 'rgv1.map.add.fn';
  let learnMode = false;
  let pressTimer = null;

  function saveSelector(sel){ try{ localStorage.setItem(LS_KEY, sel||''); }catch(_){ } }
  function loadSelector(){ try{ return localStorage.getItem(LS_KEY)||''; }catch(_){ return ''; } }
  function saveFn(name){ try{ localStorage.setItem(LS_FN, name||''); }catch(_){ } }
  function loadFn(){ try{ return localStorage.getItem(LS_FN)||''; }catch(_){ return ''; } }

  function highlight(el){
    try{
      const r = el.getBoundingClientRect();
      let o = document.getElementById('rgv1-highlight');
      if (!o){ o = document.createElement('div'); o.id='rgv1-highlight';
        o.style.cssText='position:fixed;z-index:99998;border:2px dashed #0a84ff;border-radius:12px;pointer-events:none;transition:all .15s ease;';
        document.body.appendChild(o);
      }
      o.style.left = (r.left-4)+'px'; o.style.top = (r.top-4)+'px';
      o.style.width = (r.width+8)+'px'; o.style.height = (r.height+8)+'px';
      o.style.display='block';
      setTimeout(()=>{ o.style.display='none'; }, 1200);
    }catch(_){}
  }
  function toast(msg, bg){
    try{
      let t = document.getElementById('rgv1-toast');
      if (!t){ t = document.createElement('div'); t.id='rgv1-toast';
        t.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:84px;z-index:99999;max-width:90vw;padding:10px 14px;border-radius:12px;font:14px system-ui,Segoe UI,Roboto;box-shadow:0 6px 18px rgba(0,0,0,.2);color:#fff;';
        document.body.appendChild(t);
      }
      t.style.background = bg||'#0a84ff';
      t.textContent = msg;
      t.style.display='block';
      setTimeout(()=>{ t.style.display='none'; }, 1600);
    }catch(_){}
  }
  function cssPath(el){
    if (!el || !el.nodeType) return '';
    if (el.id) return '#'+CSS.escape(el.id);
    let path=[], cur=el;
    while (cur && cur.nodeType===1 && path.length<4){
      let name = cur.nodeName.toLowerCase();
      let sel = name;
      if (cur.classList && cur.classList.length){
        sel += '.' + Array.from(cur.classList).slice(0,2).map(c=>CSS.escape(c)).join('.');
      }
      let sib=cur, idx=1;
      while ((sib=sib.previousElementSibling) && idx<10){ if (sib.nodeName===cur.nodeName) idx++; }
      sel += ':nth-of-type('+idx+')';
      path.unshift(sel);
      cur = cur.parentElement;
      if (cur && cur.id){ path.unshift('#'+CSS.escape(cur.id)); break; }
    }
    return path.join('>');
  }
  function selectBestClickable(target){
    if (!target) return null;
    const btn = target.closest('button, a, [role="button"], input[type="button"], input[type="submit"]');
    return btn || target;
  }
  function getMappedEl(){
    const sel = loadSelector();
    if (sel){
      try{ const el = document.querySelector(sel); if (el) return el; }catch(_){}
    }
    // fallback: auto-detect by data-rg-target or ids
    return document.querySelector('[data-rg-target="add"]')
        || document.getElementById('btn_plus')
        || document.getElementById('btn_add');
  }
  function callMappedFn(){
    const name = loadFn();
    const fn = (name && typeof window[name]==='function') ? window[name] : null;
    if (fn){ try{ fn(); return true; }catch(e){ console.warn('mapped fn failed', e);} }
    // heuristics: common function names
    const cand = ['RG_addNewItem','addItem','add','newItem','newEntry','openOnboarding','startOnboarding','onAdd'];
    for (let i=0;i<cand.length;i++){
      const f = window[cand[i]];
      if (typeof f === 'function'){ try{ f(); saveFn(cand[i]); return true; }catch(e){} }
    }
    return false;
  }
  function trigger(el){
    if (!el) return false;
    highlight(el);
    // Prefer native click for user activation
    try{ el.click(); return true; }catch(_){}
    // Fallback synthetic
    try{
      const ev = new MouseEvent('click', {bubbles:true, cancelable:true, composed:true});
      return el.dispatchEvent(ev);
    }catch(_){ return false; }
  }

  function enableLearnMode(){
    if (learnMode) return;
    learnMode = true;
    toast('LERNMODUS: Tippe jetzt den ECHTEN ‚Äû+‚Äú-Button der App an', '#f59e0b');
    const once = (e)=>{
      document.removeEventListener('click', once, true);
      learnMode = false;
      const el = selectBestClickable(e.target);
      if (!el){ toast('Kein Ziel erkannt', '#ef4444'); return; }
      const sel = cssPath(el);
      if (!sel){ toast('Kein Selector erzeugbar', '#ef4444'); return; }
      saveSelector(sel);
      highlight(el);
      toast('Ziel gemappt ‚úîÔ∏é', '#10b981');
    };
    document.addEventListener('click', once, true);
  }

  function wireFab(){
    const fab = document.getElementById('rgv1-fab');
    if (!fab) return;
    // short click ‚Üí trigger mapped; long press ‚Üí learn
    fab.onmousedown = fab.ontouchstart = ()=>{
      clearTimeout(pressTimer);
      pressTimer = setTimeout(enableLearnMode, 700);
    };
    const cancel = ()=>{ clearTimeout(pressTimer); };
    fab.onmouseup = fab.onmouseleave = fab.ontouchend = cancel;
    fab.onclick = (e)=>{
      // if we entered learnMode, ignore normal action
      if (learnMode) { e.preventDefault(); e.stopPropagation(); return; }
      // try mapped element
      const target = getMappedEl();
      let ok = false;
      if (target) ok = trigger(target);
      if (!ok){
        // try mapped/global function
        ok = callMappedFn();
      }
      if (!ok){
        toast('Kein Add-Target gefunden. Lange dr√ºcken f√ºr Lernmodus.', '#ef4444');
      }else{
        toast('Add ausgel√∂st', '#10b981');
      }
    };
  }

  function boot(){ wireFab(); }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();

  // Expose small debug helpers
  window.__rgv1_getAddSelector = loadSelector;
  window.__rgv1_setAddSelector = function(sel){ saveSelector(sel); };
  window.__rgv1_setAddFn = function(name){ saveFn(name); };
  window.__rgv1_tryAdd = function(){
    const el = getMappedEl();
    if (el) { highlight(el); try{ el.click(); return 'element-click'; }catch(_){ } }
    if (callMappedFn()) return 'fn-call';
    return 'no-target';
  };
})();
</script>

<script id="rgv1-mobile-js-patch">
(function(){
  function getStoredTheme(){ try{ return localStorage.getItem('rgv1_theme'); }catch(_){ return null; } }
  function storeTheme(v){ try{ localStorage.setItem('rgv1_theme', v); }catch(_){ } }
  function detectPreferred(){ try{ return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'; }catch(_){ return 'light'; } }
  function applyTheme(mode){ var root = document.documentElement; if (mode==='dark'){ root.classList.add('dark'); root.setAttribute('data-theme','dark'); } else { root.classList.remove('dark'); root.setAttribute('data-theme','light'); } storeTheme(mode); }
  function initTheme(){ var t=getStoredTheme(); if(!t){ t = document.documentElement.classList.contains('dark') || document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : detectPreferred(); } applyTheme(t); return t; }
  document.addEventListener('DOMContentLoaded', function(){
    if (window.__rgv1Enhanced) return; window.__rgv1Enhanced = true;
    var topbar = document.querySelector('.rgv1-topbar, #rgv1-topbar'); if (!topbar) return;
    var spacer = document.createElement('div'); spacer.className='rgv1-spacer'; topbar.appendChild(spacer);
    var current = initTheme();
    var tBtn=document.createElement('button'); tBtn.type='button'; tBtn.className='rgv1-btn rgv1-theme-toggle'; tBtn.setAttribute('aria-label','Theme wechseln'); tBtn.setAttribute('aria-pressed', current==='dark'?'true':'false'); tBtn.textContent = current==='dark'?'üåô':'üåû';
    tBtn.addEventListener('click', function(e){ e.preventDefault(); current=(current==='dark')?'light':'dark'; applyTheme(current); tBtn.textContent=current==='dark'?'üåô':'üåû'; tBtn.setAttribute('aria-pressed', current==='dark'?'true':'false'); }, {passive:false});
    topbar.appendChild(tBtn);
    try{ var sBtn=document.getElementById('rgv1-search'); if (sBtn && !sBtn.__rgv1Bound){ sBtn.__rgv1Bound=true; sBtn.addEventListener('click', function(e){ try{e.preventDefault();}catch(_){ } var q=document.getElementById('q')||document.querySelector('input[type="search"], input[name="q"]'); if (q){ try{ q.scrollIntoView({block:'center',behavior:'smooth'});}catch(_){ } try{ q.focus({preventScroll:true}); }catch(_){ } } }, {passive:false}); } }catch(_){ }
    try{ if (!topbar.__rgOverflow){ topbar.__rgOverflow=true; var wrap=document.createElement('div'); wrap.style.position='relative'; var btn=document.createElement('button'); btn.type='button'; btn.className='rgv1-btn rgv1-overflow'; btn.setAttribute('aria-haspopup','menu'); btn.setAttribute('aria-expanded','false'); btn.setAttribute('aria-label','Mehr'); btn.textContent='‚ãØ';
      var menu=document.createElement('div'); menu.className='rgv1-overflow-menu'; menu.hidden=true; menu.setAttribute('role','menu'); menu.innerHTML=['<button type="button" role="menuitem" data-action="ics7">ICS 7T</button>','<button type="button" role="menuitem" data-action="ics14">ICS 14T</button>','<button type="button" role="menuitem" data-action="csv">CSV</button>','<button type="button" role="menuitem" data-action="json">JSON</button>','<button type="button" role="menuitem" data-action="plus">+</button>'].join('');
      function toggleMenu(open){ var willOpen=(open==null)?menu.hidden:!!open; menu.hidden=!willOpen; btn.setAttribute('aria-expanded', String(willOpen)); }
      btn.addEventListener('click', function(e){ e.preventDefault(); toggleMenu(); }, {passive:false}); document.addEventListener('click', function(e){ if(!menu.contains(e.target)&&e.target!==btn) toggleMenu(false); }); document.addEventListener('keydown', function(e){ if(e.key==='Escape') toggleMenu(false); });
      wrap.appendChild(btn); wrap.appendChild(menu); topbar.appendChild(wrap);
      var idCandidates={ ics7:['#btn_ics7','#ics7','[data-action="ics7"]'], ics14:['#btn_ics14','#ics14','[data-action="ics14"]'], csv:['#btn_csv','#csv','[data-action="csv"]'], json:['#btn_json','#btn_export','#json','[data-action="json"]'], plus:['#rgv1-fab','#btn_add','#add','[data-action="plus"]'] };
      function trigger(list){ for (var i=0;i<list.length;i++){ var el=document.querySelector(list[i]); if(el){ el.click(); return true; } } return false; }
      menu.addEventListener('click', function(e){ var b=e.target.closest('button[role="menuitem"]'); if(!b) return; var a=b.dataset.action; trigger(idCandidates[a]||[]); toggleMenu(false); });
    } }catch(_){ }
  }, {once:true});
  try{ if(!window.hasOwnProperty('__rgEarlyBound')){ Object.defineProperty(window,'__rgEarlyBound',{value:false,writable:true,configurable:true}); } }catch(_){ }
})();
</script>
<script id="rg-ocr-integration">
const RG_OCR = (() => {
  const normalizeLineEndings = (s) => (s || "").replace(/\r\n?/g, "\n");
  function denoiseForNumbers(s){ return (s||"").replace(/O/g,"0").replace(/o/g,"0").replace(/[lI|]/g,"1").replace(/S/g,"5").replace(/\s‚Ç¨/g,"‚Ç¨").replace(/[‚Ç¨]/g," ‚Ç¨ ").replace(/[‚Äî‚Äì]/g,"-"); }
  function strip(s){ return (s||"").replace(/\u00A0/g," ").replace(/\s{2,}/g," ").trim(); }
  function parseEuro(str){
    if(!str) return null;
    let s=str.replace(/[^\d.,-]/g,"").trim();
    if(!s) return null;
    if(s.includes(",")&&s.includes(".")){ s=s.replace(/\./g,"").replace(",","."); }
    else if(s.includes(",")){ s=s.replace(",","."); }
    else if(/^\d{1,3}(?:\.\d{3})+$/.test(s)){ s=s.replace(/\./g,""); }
    const v=parseFloat(s);
    return Number.isFinite(v)?v:null;
  }
  function extractDate(text){
    const lines = normalizeLineEndings(text).split("\n").map(strip).filter(Boolean);
    const rx = /([0-3]?\d)[.\-\/]([01]?\d)[.\-\/]([12]\d{3}|\d{2})/g;
    let best = null;
    const nowY = new Date().getFullYear();
    for (let i = 0; i < lines.length; i++){
      const line = lines[i];
      let m;
      while ((m = rx.exec(line))){
        let d = +m[1], mo = +m[2], y = +m[3];
        if (y < 100) y += 2000;
        if (!(mo >= 1 && mo <= 12 && d >= 1 && d <= 31)) continue;
        if (y < 2015 || y > nowY + 1) continue;
        let score = 1;
        if (/(rechnungs?\s*datum|datum|rechnung\s*nr)/i.test(line)) score += 10;
        if (/(zahlung|bankeingang|versand|liefer)/i.test(line)) score -= 2;
        if (/(tel|fax|uid|iban|bic|kundennummer|auftragsnummer|bestellnummer)/i.test(line)) score -= 8;
        const iso = `${y}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const cand = { dateISO: iso, score, raw: m[0] };
        if (!best || cand.score > best.score || (cand.score === best.score && cand.dateISO > best.dateISO)) best = cand;
      }
    }
    return {dateISO: best ? best.dateISO : null};
  }
  function extractTime(text){ const m=text.match(/\b([01]?\d|2[0-3]):([0-5]\d)(?::([0-5]\d))?\b/); return {time:m?(m[3]?`${m[1]}:${m[2]}:${m[3]}`:`${m[1]}:${m[2]}`):null}; }
  function isLikelyInvoiceToken(token){
    if(!token) return false;
    if (!/\d/.test(token)) return false;
    if (/^\d{1,2}[.\/-]\d{1,2}[.\/-]\d{2,4}$/.test(token)) return false;
    if (/^(?:SEITE|KOPIE|DATUM)$/i.test(token)) return false;
    return token.length >= 4;
  }
  function extractInvoiceNumber(t){
    const text = normalizeLineEndings(t || "");
    const direct = text.match(/\bRechnung\s*(?:Nr|Nr\.|No|Nummer|#)\s*[:.]?\s*([A-Z0-9][A-Z0-9\-\/]{3,})/i);
    if (direct && isLikelyInvoiceToken(direct[1])) return {invoiceNumber: direct[1].replace(/[^\w\-\/]/g,"")};
    const lines = text.split("\n").map(strip).filter(Boolean);
    for (const line of lines){
      if (!/\brechnung\b/i.test(line)) continue;
      const tokens = line.match(/\b[A-Z0-9][A-Z0-9\-\/]{3,}\b/g) || [];
      for (const tok of tokens){
        if (isLikelyInvoiceToken(tok)) return {invoiceNumber: tok.replace(/[^\w\-\/]/g,"")};
      }
    }
    return {invoiceNumber:null};
  }
  function extractVatId(t){ const mAT=t.match(/\bATU\s*[\s:]*([0-9]{8,9})\b/i); if(mAT) return {vatId:`ATU ${mAT[1]}`}; const mEU=t.match(/\b([A-Z]{2}\s*\d{8,12})\b/); return {vatId:mEU?mEU[1].replace(/\s+/g," "):null}; }
  function extractPhone(t){ const m=t.match(/\b(Tel(?:efon)?\.?[:]?)[\s]*([+0]?\d[\d\s\/\-]+)\b/i); return {phone:m?strip(m[2]):null}; }
  const totalStrongRe=/(gesamtsumme|end\s*summe|zu\s*zahlen|zahlbetrag|gesamtbetrag|total\s*due)/i;
  const totalWeakRe=/(summe|gesamt|total|betrag|zahlung)/i;
  const ignoreLabelRe=/(mwst|netto|steuer|rabatt|pfand|anzahlung|teilzahlung|zwischen|skonto|%)/i;
  function extractTotalFromText(text){ const lines=normalizeLineEndings(denoiseForNumbers(text)).split("\n"); let best={score:-1,value:null,lineIdx:-1,raw:null};
    for(let i=0;i<lines.length;i++){ const line=strip(lines[i]); if(!line) continue; const c=[...line.matchAll(/(\d{1,3}(?:[.\s]\d{3})*(?:[.,]\d{2}))/g)]; if(!c.length) continue;
      const hasEUR=/\b‚Ç¨|EUR\b/i.test(line); const strong=totalStrongRe.test(line); const weak=totalWeakRe.test(line); const isIgnore=ignoreLabelRe.test(line); const hasUnitPerL=/\/\s*[lL]/.test(line);
      const base=strong?9:(weak?5:1); const eur=hasEUR?2:0; const bottom=(i>lines.length*0.55)?1:0; const penalty=(isIgnore?-6:0)+(hasUnitPerL?-3:0);
      for(const m of c){ const val=parseEuro(m[1]); if(!Number.isFinite(val)) continue; let vPenalty=0; if(val<5 && !weak && !strong) vPenalty-=1; const score=base+eur+bottom+penalty+vPenalty; if(score>best.score || (score===best.score && val>(best.value||0))){ best={score,value:val,lineIdx:i,raw:m[1]}; } }
    } return { total:best.value, totalRaw:best.raw, totalScore:best.score };
  }
  function cleanupItemCandidate(line){
    let s = strip(line);
    if(!s) return "";
    s = s.replace(/^\s*\d+\s*[A-Z]{0,4}\s+/i, '');
    s = s.replace(/^\s*[A-Z0-9\-]{4,12}\s+/i, '');
    s = s.replace(/^\s*[A-Z]{2,}\d{4,}\s+/i, '');
    s = s.replace(/\s+\d{1,3}(?:[.\s]\d{3})*(?:[.,]\d{2})(?:\s+-?\d{1,3}(?:[.,]\d{2})?%?)?(?:\s+\d{1,3}(?:[.\s]\d{3})*(?:[.,]\d{2}))?\s*$/i, '');
    return strip(s);
  }
  function extractItemName(text){
    const lines=normalizeLineEndings(text).split("\n").map(strip).filter(Boolean);
    const idx=lines.findIndex(l=>/artikelbeschreibung|bezeichnung|positions?text|aktionspreis/i.test(l));
    if(idx<0) return {productName:null};
    let best = null;
    for(let i=idx+1;i<Math.min(lines.length, idx+16);i++){
      const raw=lines[i];
      if(!raw) continue;
      if(/^(aktionspreis|artikelbeschreibung|bezeichnung|summe|gesamtsumme|zwischensumme|nettosumme|mehrwertsteuer)$/i.test(raw)) continue;
      const s = cleanupItemCandidate(raw);
      if(!s) continue;
      if (/^\[[0-9]+\]/.test(s)) continue;
      if (/(www\.|https?:|@|\.at\b|\.de\b|\.com\b)/i.test(s)) continue;
      if (/[.!?]/.test(s)) continue;
      if (/(allgemein|bedingungen|zahlbar|eigentum|empf(√§|ae)nger|liefer|versand|bankeingang|rechnungsdatum|kontakt)/i.test(s)) continue;
      const words = s.split(/\s+/).filter(Boolean);
      if (words.length > 8) continue;
      const letters = (s.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]/g)||[]).length;
      if(letters < 6 || s.length < 8) continue;
      if(/(gesamtsumme|zwischensumme|nettosumme|mehrwertsteuer|zahlung|versand|rechnung|uid|iban)/i.test(s)) continue;
      const score = letters + (/\d/.test(s) ? 2 : 0) + (s.length > 18 ? 1 : 0) + Math.max(0, 14 - (i - idx));
      if(!best || score > best.score) best = { productName: s, score };
    }
    return {productName: best ? best.productName : null};
  }
  function extractMerchantBlock(text){
    const lines=normalizeLineEndings(text).split("\n").map(strip).filter(Boolean);
    const cut=lines.findIndex(l=>/Rechnung|Kassen\s*ID|Positionen|Bezeichnung/i.test(l));
    const head=lines.slice(0, cut>0?cut:Math.min(lines.length,12));
    const companyLike = lines.find(l => /\b(gmbh|ag|kg|e\.u\.|ltd|llc|inc)\b/i.test(l) && !/www\.|@|iban|uid|tel|fax/i.test(l));
    const neureiterLike = lines.find(l => /\bneureiter\b|n\s*e\s*u\s*r\s*e\s*i\s*t\s*e\s*r/i.test(l) && !/www\.|@/i.test(l));
    let merchant = companyLike || neureiterLike || head.find(l => !/\d{4,}|tel|fax|uid|iban|www\.|@/i.test(l)) || head[0] || null;
    if (merchant && /\bneureiter\b|n\s*e\s*u\s*r\s*e\s*i\s*t\s*e\s*r/i.test(merchant)) merchant = 'Neureiter Maschinen GmbH';
    const addr=head
      .filter(l=>/\d|A-|AT-|stra√üe|str\.|weg|gasse|platz|pl\./i.test(l))
      .slice(0,3);
    return {merchant, address: addr.length?addr.join(", "):null};
  }
  function extract(payload){ const text=payload?.text?payload.text:""; const {merchant,address}=extractMerchantBlock(text); const {dateISO}=extractDate(text); const {time}=extractTime(text); const {vatId}=extractVatId(text); const {phone}=extractPhone(text); const {invoiceNumber}=extractInvoiceNumber(text); const tx=extractTotalFromText(text); const {productName}=extractItemName(text); const total=tx.total; return {merchant,address,phone,vatId,invoiceNumber,dateISO,time,productName,total,currency:Number.isFinite(total)?'EUR':null,debug:{totalFromText:tx}}; }
  return { extract };
})();
(function(){
  function sel(){ for (const s of arguments){ const el=document.querySelector(s); if(el) return el; } return null; }
  function setVal(el,val){ if(!el||val==null) return; el.value=val; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }
  function formatEUR(val, preferComma=true){ if(val==null) return ""; const s=(Math.round(val*100)/100).toFixed(2); return preferComma ? s.replace('.',',') : s; }
  function formatDateFor(el, iso){ if(!iso) return null; const [y,m,d]=iso.split('-'); if(!y) return null; if(el && (el.type==='date'||el.getAttribute('type')==='date')) return `${y}-${m}-${d}`; return `${d}.${m}.${y}`; }
  function findFields(){
    const F={};
    F.product = sel('[data-rg-field="product"]','input[name="product"]','input#product','input[placeholder*="Produkt"]');
    F.merchant= sel('[data-rg-field="merchant"]','input[name*="haendler" i]','input[name*="h√§ndler" i]','input[placeholder*="H√§ndler"]','input[placeholder*="Shop"]');
    F.date    = sel('[data-rg-field="date"]','input[type="date"]','input[name*="kaufdatum" i]','input[placeholder*="Kaufdatum"]');
    F.price   = sel('[data-rg-field="price"]','input[name*="preis" i]','input[placeholder*="Preis"]','input[name="price"]');
    F.notes   = sel('[data-rg-field="notes"]','textarea[name*="notiz" i]','textarea[placeholder*="Notiz"]','textarea');
    return F;
  }
  function setPriceField(el,total){
    if(!el || !Number.isFinite(total)) return;
    const fixed=(Math.round(total*100)/100).toFixed(2);
    const isNumber=((el.type||el.getAttribute('type')||'').toLowerCase()==='number');
    if(isNumber){ setVal(el, fixed); return; }
    const prefersComma=/Preis|‚Ç¨/i.test(el.placeholder||"") || /de|at/i.test(navigator.language||"");
    setVal(el, prefersComma ? fixed.replace('.',',') : fixed);
  }
  function applyToForm(out){
    const f=findFields();
    if(f.merchant && out.merchant) setVal(f.merchant, out.merchant);
    if(f.product && !f.product.value && out.productName) setVal(f.product, out.productName);
    else if(f.product && !f.product.value && out.merchant) setVal(f.product, out.merchant);
    if(f.date){
      const hasValue = String(f.date.value || '').trim().length > 0;
      if (!hasValue){
        const d=formatDateFor(f.date, out.dateISO);
        if(d) setVal(f.date, d);
      }
    }
    if(f.price && Number.isFinite(out.total)){ setPriceField(f.price, out.total); }
    if(f.notes){ const parts=[]; if(out.invoiceNumber) parts.push(`Rechnungsnr.: ${out.invoiceNumber}`); if(out.vatId) parts.push(`UID: ${out.vatId}`); if(out.phone) parts.push(`Tel.: ${out.phone}`); if(out.address) parts.push(out.address); if(parts.length){ const cur=(f.notes.value||"").trim(); const add=parts.join(" ‚Ä¢ "); setVal(f.notes, cur? (cur+"\n"+add) : add); } }
    console.log("[RG_OCR] applied:", out);
  }
  window.rgApplyOCR = function(ocrText, ocrWords){ const out = RG_OCR.extract({ text: ocrText, words: ocrWords }); applyToForm(out); return out; };
  function attachToTextareas(){
    const areas=[...document.querySelectorAll('textarea,[contenteditable="true"]')].filter(el=>{ const t=(el.value||el.innerText||"").toLowerCase(); return (t.includes("rechnung")||t.includes("summe")||t.includes("endsumme")) && t.length>60; });
    for(const el of areas){ if(el.__rgBtn) continue; const btn=document.createElement('button'); btn.type='button'; btn.className='rg-ocr-apply'; btn.textContent='OCR ‚Üí Formular'; btn.addEventListener('click', ()=>{ const txt=(el.value||el.innerText||""); window.rgApplyOCR(txt); }); el.insertAdjacentElement('afterend', btn); el.__rgBtn=btn; }
  }
  window.addEventListener('rg:ocrCompleted', (ev)=>{ const d=ev.detail||{}; window.rgApplyOCR(d.text||"", d.words||[]); });
  document.addEventListener('DOMContentLoaded', attachToTextareas, {once:true}); const mo=new MutationObserver(()=>attachToTextareas()); mo.observe(document.documentElement,{subtree:true,childList:true});
})();
</script>

<script>
(function(){
  try{
    const cases = [
      "A,B;C\\\n",
      "emoji üòÖ, semicolon; back\\slash",
      "line1\r\nline2",
      "line1\nline2",
      ",;\\",
      "",
      "   ",
      "quotes,;\\ and more",
      "ends with slash \\",
      "CR only\rline",
      "multi\nline\ntext",
      "normal text",
      "commas,here",
      "semi;colon",
      "back\\slash",
      "emoji üöÄ‚ú®, test; ok",
      "tabs\tignored",
      "url https://example.com?q=a,b",
      "csv-like,field;test",
      "final\ncase"
    ];
    let ok = true;
    for (const s of cases){
      const e = escapeICS(s);
      if (e.includes('\r') || /(?<!\\)[,;]/.test(e) || /\\(?![\\n,;])/u.test(e)) { ok = false; break; }
    }
    if (!ok){
      (window.__rgShowBanner ? __rgShowBanner('ICS/CSV Fuzz: Fehler in Escape-Logik') : console.warn('ICS/CSV Fuzz: failed'));
    }
  }catch(e){ console.warn('Fuzz suite error', e); }
})();
</script>

</body>
</html>
